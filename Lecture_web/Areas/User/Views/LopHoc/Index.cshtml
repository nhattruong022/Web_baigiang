@{
ViewData["Title"] = "Quản lý lớp học";
Layout = "~/Areas/User/Views/Shared/_Layout.cshtml";
var userRole = ViewBag.UserRole as string;
var lopHocPhans = ViewBag.LopHocPhans as IEnumerable<dynamic>;
  }

  <div class="class-management">
    <div class="class-header">
      <h2>Quản lý lớp học</h2>
      <div class="search-bar">
        <input type="text" placeholder="Tìm kiếm lớp học..." id="searchInput" onkeyup="searchClasses()">
      </div>

      @if (userRole == "Giangvien")
      {
      <button class="btn-primary" onclick="showAddClassModal()">
        <i class="fas fa-plus"></i>
        Thêm lớp học mới
      </button>
      }
    </div>

    <div class="class-list" id="classList">
      @if (lopHocPhans != null && lopHocPhans.Any())
      {
      @foreach (var lopHocPhan in lopHocPhans)
      {
      <div class="class-card" data-class-name="@lopHocPhan.TenLop" data-subject-name="@lopHocPhan.TenHocPhan" data-teacher-name="@lopHocPhan.TenGiangVien">
        <div class="class-info">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <img src="@(lopHocPhan.AnhDaiDienGV ?? " ~/images/avatar.jpg")" alt="GV" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
            <div>
              <a href="/User/ChiTietHocPhan/Index?idLopHocPhan=@lopHocPhan.IdLopHocPhan">
                <h3 style="margin:0;">@lopHocPhan.TenHocPhan - @lopHocPhan.TenLop</h3>
              </a>
              <div style="font-size:0.98rem;color:#555;">GV: @lopHocPhan.TenGiangVien</div>
              <div style="font-size:0.85rem;color:#777;">ID: @lopHocPhan.IdLopHocPhan</div>
            </div>
          </div>
          <div class="class-meta">
            <span><i class="fas fa-users"></i> @lopHocPhan.SoSinhVien sinh viên</span>
            <span><i class="fas fa-calendar"></i> @lopHocPhan.NgayTao.ToString("dd/MM/yyyy")</span>
          </div>
          <div class="class-desc" style="margin-top:8px;color:#444;">
            @(lopHocPhan.MoTa ?? "Không có mô tả")
          </div>
        </div>
        <div class="class-actions">
          @if (userRole == "Giangvien")
          {
          <button class="btn-primary" onclick="editClass(@lopHocPhan.IdLopHocPhan)">
            <i class="fas fa-edit"></i>
            Chỉnh sửa
          </button>
          <button class="btn-danger" onclick="deleteClass(this, @lopHocPhan.IdLopHocPhan)">
            <i class="fas fa-trash"></i>
            Xóa
          </button>
          }
          else if (userRole == "Sinhvien")
          {
          <button style="background: linear-gradient(90deg, #f39c12 60%, #f7b731 100%); color: #fff; border: none; border-radius: 6px; padding: 10px 22px; font-size: 1.08rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(243,156,18,0.13); 
            transition: background 0.2s, box-shadow 0.2s, transform 0.15s; letter-spacing: 0.5px;" class="btn-leave" onclick="leaveClass(@lopHocPhan.IdLopHocPhan)">
            <i class="fas fa-sign-out-alt"></i>
            Rời lớp
          </button>
          }
        </div>
      </div>
      }
      }
      else
      {
      <div style="padding: 40px; text-align: center; color: #666;">
        <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 16px; display: block; color: #ddd;"></i>
        <h3 style="margin-bottom: 8px; color: #666;">
          @if (userRole == "Giangvien")
          {
          <text>Chưa có lớp học nào được tạo</text>
          }
          else
          {
          <text>Bạn chưa tham gia lớp học nào</text>
          }
        </h3>
        <p style="margin: 0;">
          @if (userRole == "Giangvien")
          {
          <text>Tạo lớp học đầu tiên để bắt đầu giảng dạy.</text>
          }
          else
          {
          <text>Liên hệ giảng viên để được mời tham gia lớp học.</text>
          }
        </p>
        @if (userRole == "Giangvien")
        {
        <div style="margin-top: 16px;">
          <button class="btn-primary" onclick="showAddClassModal()">
            <i class="fas fa-plus"></i>
            Tạo lớp học mới
          </button>
        </div>
        }
      </div>
      }
    </div>

    <!-- Add/Edit Class Modal -->
    <div class="modal" id="classModal">
      <div class="modal-content" style="border-radius:16px; box-shadow:0 8px 32px rgba(52,152,219,0.18),0 1.5px 8px rgba(0,0,0,0.08); padding:0; overflow:hidden;">
        <div class="modal-header" style="background:#3498db; color:#fff; border-radius:16px 16px 0 0; display:flex; align-items:center; gap:12px; padding:24px 28px;">
          <i class="fas fa-chalkboard-teacher" style="font-size:1.6rem;"></i>
          <h2 style="flex:1; font-size:1.3rem; font-weight:600; margin:0;">Thêm lớp học mới</h2>
          <button type="button" class="close-modal" onclick="closeModal('classModal')" style="color:#fff; background:none; border:none; font-size:1.5rem; margin-left:8px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body" style="padding:32px 28px 24px 28px; background:#f8f9fa; border-radius:0 0 16px 16px;">
          <form class="class-form" onsubmit="event.preventDefault();" style="display:flex; flex-direction:column; gap:22px;">
            <div class="form-group">
              <label style="font-weight:500; color:#2c3e50; margin-bottom:7px;">Tên lớp học <span style='color:#e74c3c'>*</span></label>
              <input type="text" placeholder="Nhập tên lớp học" style="padding:13px 16px; border-radius:7px; border:1.5px solid #d0d7de; font-size:1rem; background:#fff; transition:border-color 0.2s;">
            </div>
            <div class="form-group">
              <label style="font-weight:500; color:#2c3e50; margin-bottom:7px;">Mô tả</label>
              <textarea placeholder="Nhập mô tả lớp học" style="padding:13px 16px; border-radius:7px; border:1.5px solid #d0d7de; font-size:1rem; background:#fff; min-height:80px; transition:border-color 0.2s;"></textarea>
            </div>
            <div class="form-group">
              <label>Chọn học phần <span style='color:#e74c3c'>*</span></label>
              <select style="padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #ddd;" required>
                <option value="">-- Chọn học phần --</option>
                <option value="LTWEB01">Lập trình Web</option>
                <option value="LTJAVA01">Lập trình Java</option>
                <option value="INT1235.1">Cơ sở dữ liệu</option>
                <!-- Thêm các học phần khác nếu cần -->
              </select>
            </div>
            <div class="form-actions" style="display:flex; justify-content:flex-end; gap:12px; margin-top:10px;">
              <button type="button" class="btn-secondary" onclick="closeModal('classModal')" style="min-width:110px;">Hủy</button>
              <button type="submit" class="btn-primary" style="min-width:140px; font-size:1.08rem; font-weight:600; box-shadow:0 2px 8px rgba(52,152,219,0.10);">Lưu <i class="fas fa-save" style="margin-left:7px;"></i></button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal xác nhận xóa lớp học phần -->
    <div class="modal" id="confirmDeleteModal">
      <div class="modal-content">
        <div class="modal-header" style="justify-content:center;">
          <h2 style="font-size:1.1rem; margin:0 auto;">Xác nhận xóa</h2>
        </div>
        <div class="modal-form" style="padding:20px;">
          <p>Bạn có chắc chắn muốn xóa lớp học phần này?</p>
          <div style="display:flex; justify-content:center; gap:16px; margin-top:20px;">
            <button class="btn-secondary" onclick="closeConfirmDelete()">Hủy</button>
            <button class="btn-danger" onclick="confirmDeleteClass()">Xóa</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Biến global để lưu ID lớp học cần xóa
    let classIdToDelete = null;

    // Hàm tìm kiếm lớp học
    function searchClasses() {
      const input = document.getElementById('searchInput');
      const filter = input.value.toLowerCase();
      const classList = document.getElementById('classList');
      const classCards = classList.getElementsByClassName('class-card');

      for (let i = 0; i < classCards.length; i++) {
        const card = classCards[i];
        const className = card.getAttribute('data-class-name').toLowerCase();
        const subjectName = card.getAttribute('data-subject-name').toLowerCase();
        const teacherName = card.getAttribute('data-teacher-name').toLowerCase();

        if (className.indexOf(filter) > -1 ||
          subjectName.indexOf(filter) > -1 ||
          teacherName.indexOf(filter) > -1) {
          card.style.display = "";
        } else {
          card.style.display = "none";
        }
      }
    }

    function showAddClassModal() {
      document.getElementById('classModal').style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function editClass(classId) {
      alert('Chỉnh sửa lớp học có ID: ' + classId);
      // TODO: Implement edit functionality
    }

    function deleteClass(element, classId) {
      classIdToDelete = classId;
      document.getElementById('confirmDeleteModal').style.display = 'block';
    }

    function closeConfirmDelete() {
      document.getElementById('confirmDeleteModal').style.display = 'none';
      classIdToDelete = null;
    }

    function confirmDeleteClass() {
      if (classIdToDelete) {
        alert('Xóa lớp học có ID: ' + classIdToDelete);
        // TODO: Implement delete functionality
        closeConfirmDelete();
      }
    }

    function leaveClass(classId) {
      if (confirm('Bạn có chắc chắn muốn rời khỏi lớp học này?')) {
        alert('Rời khỏi lớp học có ID: ' + classId);
        // TODO: Implement leave class functionality
      }
    }

    // Đóng modal khi click ra ngoài
    window.onclick = function(event) {
      const modals = document.getElementsByClassName('modal');
      for (let i = 0; i < modals.length; i++) {
        if (event.target == modals[i]) {
          modals[i].style.display = 'none';
        }
      }
    }
  </script>