@model Lecture_web.Models.ViewModels.EditBaiViewModel    
@{
    ViewData["Title"] = "Chỉnh sửa bài";
    Layout = "~/Areas/User/Views/Shared/_Layout.cshtml";
    }

@section style {
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/45.2.1/ckeditor5.css" />

        <style>
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 140px;
            min-height: 100vh;
        }
            .bai-modal-form textarea {
                min-height: 400px;
                height: auto;

            }

            .bai-modal-form{
                max-width: 1200px !important;
                margin:0px 0px !important;
                width:auto;
            }

            .text-danger {
                color: red !important;
                width: 100%;
            }

        .ck-editor__main, .ck-editor__editable_inline {
                height: 400px;
                max-height: 400px;
                overflow-y: auto;
                resize: none;
        
            }

        .ck-content iframe {
            pointer-events: auto;
        }


        .ck-content .ck-media .ck-widget__wrapper {
            padding-bottom: 56.25% !important;
        }

        .ck-editor__editable.ck-content ol {
            list-style-type: decimal;
            margin-left: 1.5em;
            padding-left: 0;
        }

        .ck-editor__editable.ck-content ul {
            list-style-type: disc;
            margin-left: 1.5em;
            padding-left: 0;
        }

        .ck-editor__editable.ck-content li {
            margin: 0.5em 0;
        }

        .ck-editor__editable.ck-content iframe {
            pointer-events: auto;
        }



        .ck-content figure.image.image-style-side {
            float: right; 
            margin: 0 1em 1em 0; 
        }


        .ck-content p > img {
            display: inline; 
            vertical-align: middle; 
            margin: 0 .2em; 
        }


        .ck-content figure.image {
            display: block;
            margin: 1em auto; 
        }


        .ck-content figure.image {
            clear: both;
        }

 
        </style>

    }

    <main class="main-content">
        <div class="assignment-management-container">
            <div class="assignment-header">
                <h2>Chỉnh sửa bài</h2>
            </div>
            <form asp-area="User"
                  asp-controller="QuanLyBai"
                  asp-action="EditBai"
                  id="editBaiForm"
                  method="post"
                  class="bai-modal-form"
                  style="max-width:800px;margin:30px auto;">
                @Html.AntiForgeryToken()

                <input asp-for="IdBai" type="hidden" />
                <input asp-for="IdChuong" type="hidden" />

                <div class="form-group">
                    <label asp-for="TieuDeBai">Tiêu đề</label>
                <input asp-for="TieuDeBai" class="form-control" maxlength="" />
                    <span asp-validation-for="TieuDeBai" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="NoiDung"> Nội dung</label>
                    
                    <textarea asp-for="NoiDung" 
                    class="form-control" 
                    rows="6"
                    id="NoiDungEditor">
                
                    </textarea>
                    <span asp-validation-for="NoiDung" class="text-danger"></span>
                </div>
                <div class="form-actions" style="text-align:right">
                    <a asp-area="User"
                       asp-controller="QuanLyChuong"
                       asp-action="Index"
                       asp-route-idbg="@Model.IdBaiGiang"
                       class="btn-secondary">Hủy</a>
                    <button type="submit" class="btn-primary">
                        Lưu <i class="fas fa-save"></i>
                    </button>
                </div>
            </form>
        </div>
    </main>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.0/classic/ckeditor.js"></script>
@*     <script src="~/lib/ckeditor5/ckeditor.js"></script> *@

  <script>

        ClassicEditor
            .create(document.querySelector('#NoiDungEditor'), {
                toolbar: [
                    'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', 'link', 'blockQuote', 'insertTable',
                    '|', 'bulletedList', 'numberedList',
                    '|', 'mediaEmbed', 'undo', 'redo', 'imageStyle:alignLeft', 'imageStyle:center', 'imageStyle:alignRight'
                ],
                mediaEmbed: {
                    previewsInData: true,

  
                    extraProviders: [
                        {
                            name: 'drive',
                            url: [
                                /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/view/
                            ],
                            html: match => {
                                const id = match[1];
                                return (
                                    '<div style="position:relative;padding-bottom:56.25%;height:0;">' +
                                    `<iframe src="https://drive.google.com/file/d/${id}/preview" ` +
                                    'style="position:absolute;top:0;left:0;width:100%;height:100%;" ' +
                                    'frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>' +
                                    '</iframe>' +
                                    '</div>'
                                );
                            }
                        }
                    ]
                },


                link: {
                    decorators: {
                        addTargetBlank: {
                            mode: 'automatic',
                            callback: () => true,
                            attributes: {
                                target: '_blank',
                                rel: 'noopener noreferrer'
                            }
                        }
                    }
                },
            })
            .then(editor => window.editorInstance = editor)
            .catch(console.error);


        $('#editBaiForm').on('submit', function (e) {
            e.preventDefault();
            var $f = $(this),
                url = $f.attr('action'),
                data = $f.serialize(),
                token = $f.find('input[name="__RequestVerificationToken"]').val();

 
            $f.find('span.text-danger').text('');

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                headers: { 'RequestVerificationToken': token }
            })
                .done(function (resp) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã cập nhật bài',
                        timer: 1200,
                        showConfirmButton: false
                    }).then(function () {
                        window.location.href = '@Url.Action("Index", "QuanLyChuong", new { area = "User", idbg = Model.IdBaiGiang })';
                    });
                })
                .fail(function (xhr) {
                    if (xhr.status === 400 && xhr.responseJSON.errors) {
                        var errs = xhr.responseJSON.errors;
                        $f.find('.is-invalid').removeClass('is-invalid');
                        $f.find('span[data-valmsg-for]').text('');
                        $.each(errs, function (field, messages) {
                            var $msg = $f.find('span.text-danger[data-valmsg-for="' + field + '"]');
                            $msg.text(messages[0]);
                        });
                    } else {
                        alert('Lỗi server, thử lại');
                    }
                });
        });


    </script>




}