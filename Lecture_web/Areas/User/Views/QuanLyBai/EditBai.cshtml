@model Lecture_web.Models.ViewModels.EditBaiViewModel    
@{
    ViewData["Title"] = "Chỉnh sửa bài";
    Layout = "~/Areas/User/Views/Shared/_Layout.cshtml";
    }

@section style {
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/elfinder/2.1.59/css/elfinder.min.css" />
        <style>
            .bai-modal-form textarea {
                min-height: 400px;
                height: auto;

            }

            .bai-modal-form{
                max-width: 1200px !important;
                margin:0px 0px !important;
                width:auto;
            }

            .text-danger {
                color: red !important;
                width: 100%;
            }

            .ck-editor__main {
                height: 400px;
                max-height: 400px;
                overflow-y: auto;
                resize: none;
        
            }
        </style>

    }

    <main class="main-content">
        <div class="assignment-management-container">
            <div class="assignment-header">
                <h2>Chỉnh sửa bài</h2>
            </div>
            <form asp-area="User"
                  asp-controller="QuanLyBai"
                  asp-action="EditBai"
                  id="editBaiForm"
                  method="post"
                  class="bai-modal-form"
                  style="max-width:800px;margin:30px auto;">
                @Html.AntiForgeryToken()

                <input asp-for="IdBai" type="hidden" />
                <input asp-for="IdChuong" type="hidden" />

                <div class="form-group">
                    <label asp-for="TieuDeBai"></label>
                    <input asp-for="TieuDeBai" class="form-control" />
                    <span asp-validation-for="TieuDeBai" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="NoiDung"></label>
                    
                    <textarea asp-for="NoiDung" 
                    class="form-control" 
                    rows="6"
                    id="NoiDungEditor">
                
                    </textarea>
                    <span asp-validation-for="NoiDung" class="text-danger"></span>
                </div>

            <div class="form-group">
                <label>Chèn media</label>
                <button type="button" id="btnBrowseMedia" class="btn btn-secondary">Chọn ảnh/video</button>
                <!-- Container elFinder, ẩn ban đầu -->
                <div id="elfinder" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; z-index:1000; background:white;"></div>
            </div>
                <div class="form-actions" style="text-align:right">
                    <a asp-area="User"
                       asp-controller="QuanLyChuong"
                       asp-action="Index"
                       asp-route-idbg="@Model.IdBaiGiang"
                       class="btn-secondary">Hủy</a>
                    <button type="submit" class="btn-primary">
                        Lưu <i class="fas fa-save"></i>
                    </button>
                </div>
            </form>
        </div>
    </main>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.0/classic/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elfinder/2.1.59/js/elfinder.min.js"></script>

  <script>
        let editor5;
        ClassicEditor
            .create(document.querySelector('#NoiDungEditor'), {
                toolbar: [
                    'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', 'link', 'blockQuote', 'code', 'codeBlock', 'insertTable',
                    '|', 'bulletedList', 'numberedList', '|', 'uploadImage', 'mediaEmbed', '|', 'undo', 'redo'
                ]
            })
            .then(ed => { editor5 = ed; })
            .catch(error => console.error(error));

        // Hàm mở elFinder
        document.getElementById('btnBrowseMedia').addEventListener('click', () => {
            const elfDiv = document.getElementById('elfinder');
            if (!elfDiv.getAttribute('data-initialized')) {
                $('#elfinder').elfinder({
                    url: '/elfinder/connector',  // endpoint elFinder.NetCore
                    customData: { /* có thể truyền lessonId nếu cài custom backend */ },
                    handlers: {
                        destroy: function () {
                            elfDiv.style.display = 'none';
                        },
                        select: function (event) {
                            // Khi user chọn file và bấm "Select"
                            const file = event.data.file;
                            const url = file.url; // URL nội bộ, ví dụ /uploads/xxx.jpg
                            if (url) {
                                // Chèn vào CKEditor5 tại vị trí con trỏ
                                editor5.model.change(writer => {
                                    // Xác định type media: nếu ảnh, chèn <imageBlock> hoặc <imageInline>; nếu video, chèn <mediaEmbed>
                                    const ext = url.split('.').pop().toLowerCase();
                                    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                                        const imageElement = writer.createElement('imageBlock', {
                                            src: url
                                        });
                                        editor5.model.insertContent(imageElement, editor5.model.document.selection);
                                    } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
                                        // mediaEmbed dùng URL embed, CKEditor5 mediaEmbed plugin hỗ embed nhiều nguồn;
                                        // Nhưng để chèn video tự host, ta có thể chèn HTML <video> qua HTML embed:
                                        const html = `<video controls src="${url}"></video>`;
                                        const viewFragment = editor5.data.processor.toView(html);
                                        const modelFragment = editor5.data.toModel(viewFragment);
                                        editor5.model.insertContent(modelFragment, editor5.model.document.selection);
                                    } else {
                                        // Khác (PDF/docx): chèn link
                                        const linkHtml = `<a href="${url}" target="_blank">${file.name}</a>`;
                                        const viewFrag = editor5.data.processor.toView(linkHtml);
                                        const modelFrag = editor5.data.toModel(viewFrag);
                                        editor5.model.insertContent(modelFrag, editor5.model.document.selection);
                                    }
                                });
                            }
                            // Ẩn elFinder sau khi chọn
                            elfDiv.style.display = 'none';
                        }
                    },
                    uiOptions: {
                        // tuỳ chỉnh toolbar hoặc commands nếu muốn
                    }
                });
                elfDiv.setAttribute('data-initialized', 'true');
            }
            elfDiv.style.display = 'block';
        });

        $('#editBaiForm').on('submit', function (e) {
            e.preventDefault();
            var $f = $(this),
                url = $f.attr('action'),
                data = $f.serialize(),
                token = $f.find('input[name="__RequestVerificationToken"]').val();

            // xóa lỗi cũ
            $f.find('span.text-danger').text('');

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                headers: { 'RequestVerificationToken': token }
            })
                .done(function (resp) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã cập nhật bài',
                        timer: 1200,
                        showConfirmButton: false
                    }).then(function () {
                        window.location.href = '@Url.Action("Index", "QuanLyChuong", new { area = "User", idbg = Model.IdBaiGiang })';
                    });
                })
                .fail(function (xhr) {
                    if (xhr.status === 400 && xhr.responseJSON.errors) {
                        var errs = xhr.responseJSON.errors;
                        $f.find('span.text-danger').text('');
                        $.each(errs, function (field, messages) {
                            var $msg = $f.find('span.text-danger[data-valmsg-for="' + field + '"]');
                            $msg.text(messages[0]);
                        });
                    } else {
                        alert('Lỗi server, thử lại');
                    }
                });
        });


    </script>




}