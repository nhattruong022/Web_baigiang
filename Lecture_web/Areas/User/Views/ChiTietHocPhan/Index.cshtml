@{
ViewData["Title"] = "Chi tiết học phần";
var userRole = ViewBag.UserRole as string;
var currentUser = ViewBag.CurrentUser as Lecture_web.Models.TaiKhoanModels;
var currentUserAvatar = currentUser?.AnhDaiDien ?? "/images/avatar.jpg";
var currentUserName = currentUser?.HoTen ?? "Người dùng";
<link rel="stylesheet" href="~/css/chitiethocphan.css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
}

@* CSRF Token for AJAX calls *@
@Html.AntiForgeryToken()

<div class="app-container">
  <div class="header-row" style="display: flex; align-items: center; gap: 16px; margin: 24px 24px 0 32px;">
    <a style="text-decoration: none; color: #22334d;" href="/User/LopHoc/Index" class="back-btn">
      <i class="fas fa-arrow-left"></i> Quay lại
    </a>
    <div class="course-tabs">
      <button class="course-tab-btn active" onclick="showTab('lessons', this)"><i class="fas fa-book"></i> Bài giảng</button>
      <button class="course-tab-btn" onclick="showTab('students', this)"><i class="fas fa-users"></i> Danh sách sinh viên</button>
      <button class="course-tab-btn" onclick="showTab('notices', this)"><i class="fas fa-bell"></i> Thông báo</button>
    </div>
  </div>
  <div class="main-box" style="background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(52,152,219,0.10), 0 1.5px 8px rgba(0,0,0,0.08); border: 1.5px solid #bfc9d1; overflow: visible; margin: 16px 24px 0 24px; display: flex; flex-direction: row; min-height: 650px;">
    <!-- Sidebar chương & bài -->
    <aside class="sidebar-chapters">
      <h2>Chương & Bài</h2>
      <ul class="chapter-list" id="chaptersList">
        <!-- Sẽ được render bởi JavaScript từ ViewBag.Chuongs -->
        <li style="padding: 20px; text-align: center; color: #666;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
          Đang tải chương và bài...
        </li>
      </ul>
    </aside>
    <div style="flex:1;display:flex;flex-direction:column;min-height: 600px;">
      <!-- Tab Contents -->
      <section class="main-lesson-content course-tab-content" id="tab-lessons" style="display:block;">
        <!-- Nội dung bài sẽ được render ở đây -->
      </section>
      <section class="main-lesson-content course-tab-content" id="tab-students" style="display:none;">
        <div class="management-header">
          <div class="search-filter">

            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="studentSearchInput" placeholder="Tìm kiếm sinh viên theo tên, email, tên đăng nhập..." oninput="searchStudentsInList(this.value)" onkeyup="searchStudentsInList(this.value)">
            </div>
            @if (userRole != "Sinhvien")
            {
            <button onclick="openInviteStudentModal()" class="invite-student-btn" title="Mời sinh viên">
              <i class="fas fa-plus"></i>
              <span>Mời sinh viên</span>
            </button>
            }
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <div id="studentsInfo" style="font-size: 0.9rem; color: #666;">
              <!-- Thông tin số lượng sinh viên sẽ được cập nhật bởi JavaScript -->
            </div>
          </div>
        </div>
        <div class="student-table">
          <table>
            <thead>
              <tr>
                <th>Tên đăng nhập</th>
                <th>Họ và tên</th>
                <th>Vai trò</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Ảnh đại diện</th>
                <th>Trạng thái</th>
                @if (userRole != "Sinhvien")
                {
                <th>Thao tác</th>
                }
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              @{
              var studentsInClass = ViewBag.StudentsInClass as IEnumerable<dynamic>;
                }

                <!-- DEBUG: Kiểm tra data sinh viên -->
                @if (ViewBag.StudentsInClass != null)
                {
                <script>
                  console.log('StudentsInClass data:', @Html.Raw(Json.Serialize(ViewBag.StudentsInClass)));
                </script>
                }

                @if (studentsInClass != null && studentsInClass.Any())
                {
                @foreach (var student in studentsInClass)
                {
                <tr>
                  <td>@student.TenDangNhap</td>
                  <td>@student.HoTen</td>
                  <td>@(student.VaiTro == "Sinhvien" ? "Sinh viên" : student.VaiTro)</td>
                  <td>@student.Email</td>
                  <td>@(student.SoDienThoai ?? "Chưa cập nhật")</td>
                  <td>
                    @if (!string.IsNullOrEmpty(student.AnhDaiDien))
                    {
                    <img style="width:52px; height:52px; border-radius:50%;" src="@(!string.IsNullOrEmpty(student.AnhDaiDien) ? student.AnhDaiDien : " /images/avatar.jpg")" class="student-avatar" />
                    }
                    else
                    {
                    <img style="width:52px; height:52px; border-radius:50%;" src="/images/avatar.jpg" class="student-avatar" />
                    }
                  </td>
                  <td><span class="status-badge @(student.TrangThai == " HoatDong" ? "hoatdong" : "" )">@(student.TrangThai == "HoatDong" ? "Hoạt động" : (student.TrangThai ?? "Chưa cập nhật"))</span></td>
                  @if (userRole != "Sinhvien")
                  {
                  <td>
                    <button class="btn-icon" onclick="openEditStudentModal(this)"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="openConfirmDeleteStudentModal(this)"><i class="fas fa-trash"></i></button>
                  </td>
                  }
                </tr>
                }
                }
                else
                {
                <tr>
                  <td colspan="@(userRole != " Sinhvien" ? "8" : "7" )" style="text-align: center; padding: 20px; color: #666;">
                    <i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                    Chưa có sinh viên nào trong lớp học này
                    @if (userRole != "Sinhvien")
                    {
                    <div style="margin-top: 12px;">
                      <button onclick="openInviteStudentModal()" class="invite-student-btn" style="padding: 8px 16px !important; font-size: 0.95rem !important; min-width: auto !important;">
                        <i class="fas fa-plus" style="margin-right: 8px;"></i> Mời sinh viên tham gia
                      </button>
                    </div>
                    }
                  </td>
                </tr>
                }
            </tbody>
          </table>
        </div>
        <!-- Phân trang -->
        <div id="studentsPagination">
          @Html.Partial("_PaginationPartial")
        </div>

        <!-- Popup Mời học viên -->
        @if (userRole != "Sinhvien")
        {
        <div class="modal" id="inviteStudentModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(44,62,80,0.18); justify-content:center; align-items:center;">
          <div class="modal-content" style="background:#fff; border-radius:14px; box-shadow:0 8px 32px rgba(52,152,219,0.18),0 1.5px 8px rgba(0,0,0,0.08); padding:0; width:420px; max-width:90vw; position:relative; overflow:hidden;">
            <div class="modal-header" style="background:#fff; padding:20px 24px 16px 24px; border-bottom:1px solid #e5e5e5;">
              <h2 style="font-size:1.2rem; font-weight:600; color:#333; margin:0;">Mời học viên</h2>
              <button onclick="closeInviteStudentModal()" style="position:absolute; top:16px; right:20px; background:none; border:none; font-size:1.3rem; color:#666; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="padding:20px 24px;">
              <div style="margin-bottom:16px;">
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                  <select id="searchType" style="padding:12px; border:1px solid #ddd; border-radius:8px; background:white; min-width:140px;" onchange="updateSearchPlaceholder()">
                    <option value="all">Tất cả</option>
                    <option value="email">Email</option>
                    <option value="name">Họ tên</option>
                    <option value="username">Tên đăng nhập</option>
                    <option value="phone">Số điện thoại</option>
                  </select>
                  <input type="text" id="searchStudentEmail" placeholder="Tìm kiếm sinh viên..." style="flex:1; padding:12px 16px; border:1px solid #ddd; border-radius:8px; font-size:1rem; outline:none;" oninput="searchStudentWithType(this.value)" onkeyup="searchStudentWithType(this.value)">
                </div>
                <div style="font-size:0.85rem; color:#666; margin-top:4px;">
                  Nhập từ khóa để tìm kiếm sinh viên theo tiêu chí đã chọn
                </div>
              </div>

              <!-- Hiển thị sinh viên đã chọn -->
              <div id="selectedStudentsContainer" style="margin-bottom:16px; display:none;">
                <h4 style="font-size:0.9rem; color:#333; margin-bottom:8px;">Sinh viên đã chọn:</h4>
                <div id="selectedStudentsList" style="max-height:100px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:6px; padding:8px;">
                  <!-- Selected students will be displayed here -->
                </div>
                <div style="margin-top:8px; text-align:right;">
                  <button type="button" onclick="clearSelectedStudents()" style="background:none; border:1px solid #ddd; color:#666; padding:4px 8px; border-radius:4px; font-size:0.8rem; cursor:pointer;">Xóa tất cả chọn</button>
                </div>
              </div>

              <div id="searchResults" style="max-height:200px; overflow-y:auto;">
                <!-- Kết quả tìm kiếm sẽ hiển thị ở đây -->
              </div>
              <div style="color:#666; font-size:0.9rem; margin-top:12px; text-align:center;">
                Tìm kiếm và chọn nhiều sinh viên để mời cùng lúc
              </div>
            </div>
            <div class="modal-footer" style="padding:16px 24px; background:#f8f9fa; display:flex; justify-content:space-between; align-items:center;">
              <div id="selectedCount" style="font-size:0.9rem; color:#666;">
                Đã chọn: <span id="selectedCountNumber">0</span> sinh viên
              </div>
              <div style="display:flex; gap:12px;">
                <button type="button" onclick="closeInviteStudentModal()" style="padding:8px 20px; border:1px solid #ddd; background:#fff; color:#666; border-radius:6px; font-size:0.95rem; cursor:pointer;">Hủy</button>
                <button type="button" onclick="inviteSelectedStudent()" id="inviteButton" style="padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:6px; font-size:0.95rem; cursor:pointer;" disabled>Mời</button>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Popup chỉnh sửa sinh viên -->
        @if (userRole != "Sinhvien")
        {
        <div class="modal" id="editStudentModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100vw; height:100vh; background:rgba(44,62,80,0.18); justify-content:center; align-items:center;">
          <div class="modal-content add-student-modal-content">
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e6ed; padding-bottom:18px; margin-bottom:24px;">
              <h2 style="font-size:1.35rem; font-weight:700; color:#22334d; margin:0;">Chỉnh sửa sinh viên</h2>
              <button onclick="closeEditStudentModal()" style="background:none; border:none; font-size:1.3rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <form id="editStudentForm" onsubmit="submitEditStudent(event)">
              <div class="form-group">
                <label for="editStudentUsername">Tên đăng nhập</label>
                <input type="text" id="editStudentUsername" required>
              </div>
              <div class="form-group">
                <label for="editStudentName">Họ và tên</label>
                <input type="text" id="editStudentName" required>
              </div>
              <div class="form-group">
                <label for="editStudentRole">Vai trò</label>
                <select id="editStudentRole" required>
                  <option value="student">Sinh viên</option>
                  <option value="teacher">Giảng viên</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editStudentEmail">Email</label>
                <input type="email" id="editStudentEmail" required>
              </div>
              <div class="form-group">
                <label for="editStudentPhone">Số điện thoại</label>
                <input type="text" id="editStudentPhone">
              </div>
              <div class="form-group">
                <label for="editStudentAvatar">Ảnh đại diện</label>
                <input type="file" id="editStudentAvatar" accept="image/*">
              </div>
              <div class="form-group">
                <label for="editStudentStatus">Trạng thái</label>
                <select id="editStudentStatus" required>
                  <option value="hoatdong">Hoạt động</option>
                  <option value="khonghoatdong">Không hoạt động</option>
                </select>
              </div>
              <div class="form-actions modal-actions">
                <button type="button" onclick="closeEditStudentModal()" class="btn-cancel">Hủy</button>
                <button type="submit" class="btn-primary">Lưu thay đổi</button>
              </div>
            </form>
          </div>
        </div>
        }
        <!-- Modal xác nhận xóa sinh viên -->
        @if (userRole != "Sinhvien")
        {
        <div class="modal" id="confirmDeleteStudentModal" style="display:none; position:fixed; z-index:1002; left:0; top:0; width:100vw; height:100vh; background:rgba(44,62,80,0.18); justify-content:center; align-items:center;">
          <div class="modal-content" style="min-width:350px; max-width:400px; background:#fff; border-radius:14px; box-shadow:0 8px 32px rgba(52,152,219,0.18),0 1.5px 8px rgba(0,0,0,0.08); padding:32px 28px 24px 28px; position:relative; display:flex; flex-direction:column; align-items:center;">
            <h2 style="font-size:1.2rem; font-weight:600; color:#22334d; margin-bottom:18px; text-align:center;">Xác nhận xóa sinh viên?</h2>
            <div style="display:flex; justify-content:center; gap:16px; margin-top:18px;">
              <button type="button" onclick="closeConfirmDeleteStudentModal()" class="btn-cancel">Hủy</button>
              <button type="button" onclick="confirmDeleteStudent()" class="btn-primary" style="background:#e74c3c; border:none;">Xóa</button>
            </div>
          </div>
        </div>
        }
      </section>
      <section class="main-lesson-content course-tab-content" id="tab-notices" style="display:none;">
        <!-- Nội dung thông báo sẽ được load từ API -->
        <div style="padding: 40px; text-align: center; color: #666;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
          Đang tải thông báo...
        </div>
      </section>
      @if (userRole == null || userRole.ToLower() != "sinhvien")
      {
      <div class="modal" id="addNoticeModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100vw; height:100vh; background:rgba(44,62,80,0.18); justify-content:center; align-items:center;">
        <div class="modal-content add-notice-modal-content">
          <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e6ed; padding-bottom:18px; margin-bottom:24px;">
            <h2 style="font-size:1.35rem; font-weight:700; color:#22334d; margin:0;">Thêm thông báo</h2>
            <button onclick="closeAddNoticeModal()" style="background:none; border:none; font-size:1.3rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <form id="addNoticeForm" onsubmit="submitAddNotice(event)">
            <div class="form-group">
              <label for="noticeTitle">Tiêu đề</label>
              <input type="text" id="noticeTitle" required>
            </div>
            <div class="form-group">
              <label for="noticeContent">Nội dung</label>
              <textarea id="noticeContent" rows="5" required style="resize:vertical;"></textarea>
            </div>
            <div class="modal-actions">
              <button type="button" onclick="closeAddNoticeModal()" class="btn-cancel">Hủy</button>
              <button type="submit" class="btn-primary">Thêm</button>
            </div>
          </form>
        </div>
      </div>
      }
      @if (userRole == null || userRole.ToLower() != "sinhvien")
      {
      <div class="modal" id="editNoticeModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100vw; height:100vh; background:rgba(44,62,80,0.18); justify-content:center; align-items:center;">
        <div class="modal-content add-notice-modal-content">
          <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e6ed; padding-bottom:18px; margin-bottom:24px;">
            <h2 style="font-size:1.35rem; font-weight:700; color:#22334d; margin:0;">Sửa thông báo</h2>
            <button onclick="closeEditNoticeModal()" style="background:none; border:none; font-size:1.3rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <form id="editNoticeForm" onsubmit="submitEditNotice(event)">
            <div class="form-group">
              <label for="editNoticeTitle">Tiêu đề</label>
              <input type="text" id="editNoticeTitle" required>
            </div>
            <div class="form-group">
              <label for="editNoticeContent">Nội dung</label>
              <textarea id="editNoticeContent" rows="5" required style="resize:vertical;"></textarea>
            </div>
            <div class="modal-actions">
              <button type="button" onclick="closeEditNoticeModal()" class="btn-cancel">Hủy</button>
              <button type="submit" class="btn-primary">Lưu</button>
            </div>
          </form>
        </div>
      </div>
      }
      @if (userRole == null || userRole.ToLower() != "sinhvien")
      {
      <div class="modal" id="confirmDeleteNoticeModal" style="display:none; position:fixed; z-index:1002; left:0; top:0; width:100vw; height:100vh; background:rgba(44,62,80,0.18); justify-content:center; align-items:center;">
        <div class="modal-content" style="min-width:350px; max-width:400px; background:#fff; border-radius:14px; box-shadow:0 8px 32px rgba(52,152,219,0.18),0 1.5px 8px rgba(0,0,0,0.08); padding:32px 28px 24px 28px; position:relative; display:flex; flex-direction:column; align-items:center;">
          <h2 style="font-size:1.2rem; font-weight:600; color:#22334d; margin-bottom:18px; text-align:center;">Xác nhận xóa thông báo?</h2>
          <div style="display:flex; justify-content:center; gap:16px; margin-top:18px;">
            <button type="button" onclick="closeConfirmDeleteNoticeModal()" class="btn-cancel">Hủy</button>
            <button type="button" onclick="confirmDeleteNotice()" class="btn-primary" style="background:#e74c3c; border:none;">Xóa</button>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

<script>
  let selectedStudentsForInvite = []; // Thay đổi từ single student thành array
  let currentLopHocPhanId = @(ViewBag.IdLopHocPhan ?? 1);
  let currentStudentPage = @(ViewBag.CurrentPage ?? 1);
  let totalStudentPages = @(ViewBag.TotalPages ?? 1);
  let totalStudents = @(ViewBag.TotalStudents ?? 0);
  let hasUnloadedNotifications = false; // Theo dõi có thông báo mới chưa được load

  console.log('DEBUG: currentLopHocPhanId =', currentLopHocPhanId);
  console.log('DEBUG: Pagination info - current page:', currentStudentPage, 'total pages:', totalStudentPages, 'total students:', totalStudents);

  // Dữ liệu lessons từ ViewBag.Chuongs
  const chuongsData = @Html.Raw(Json.Serialize(ViewBag.Chuongs ?? new List < object > ()));

  console.log('DEBUG: chuongsData =', chuongsData);
  console.log('DEBUG: chuongsData type =', typeof chuongsData);
  console.log('DEBUG: chuongsData length =', chuongsData ? chuongsData.length : 'null');

  // Debug từng chương
  if (chuongsData && chuongsData.length > 0) {
    chuongsData.forEach((chuong, idx) => {
      console.log(`DEBUG: Chuong ${idx}:`, chuong);
      console.log(`DEBUG: Chuong ${idx} - tenChuong:`, chuong.tenChuong || chuong.TenChuong);
      console.log(`DEBUG: Chuong ${idx} - bais:`, chuong.bais || chuong.Bais);
      const baisList = chuong.bais || chuong.Bais;
      if (baisList && baisList.length > 0) {
        baisList.forEach((bai, baiIdx) => {
          console.log(`DEBUG: Bai ${baiIdx}:`, bai);
          console.log(`DEBUG: Bai ${baiIdx} - tieuDeBai:`, bai.tieuDeBai || bai.TieuDeBai);
        });
      }
    });
  } else {
    console.log('DEBUG: No chuongsData found or empty array');
  }

  // Function để render sidebar từ dữ liệu
  function renderChaptersList() {
    const chaptersList = document.getElementById('chaptersList');

    if (!chuongsData || chuongsData.length === 0) {
      chaptersList.innerHTML = `
        <li style="padding: 20px; text-align: center; color: #666;">
          <i class="fas fa-book" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
          Chưa có chương nào được tạo
        </li>
      `;
      return;
    }

    let html = '';
    chuongsData.forEach((chuong, chapterIdx) => {
      const tenChuong = chuong.tenChuong || chuong.TenChuong || `Chương ${chapterIdx + 1}`;
      const baisList = chuong.bais || chuong.Bais || [];

      html += `
        <li class="chapter ${chapterIdx === 0 ? 'open' : ''}">
          <button class="chapter-title ${chapterIdx === 0 ? 'active' : ''}" onclick="toggleChapter(this)">
            ${tenChuong}
            <i class="fas fa-chevron-down" style="margin-left:auto"></i>
          </button>
          <ul class="lesson-list">
      `;

      if (baisList && baisList.length > 0) {
        baisList.forEach((bai, lessonIdx) => {
          const tieuDeBai = bai.tieuDeBai || bai.TieuDeBai || `Bài ${lessonIdx + 1}`;
          const lessonNumber = lessonIdx + 1;
          html += `
            <li>
              <button class="lesson-btn ${chapterIdx === 0 && lessonIdx === 0 ? 'active' : ''}" onclick="showLesson(${chapterIdx}, ${lessonIdx})">
                <span class="lesson-number">${lessonNumber}</span>
                <span class="lesson-title">${tieuDeBai}</span>
              </button>
            </li>
          `;
        });
      } else {
        html += `
          <li style="padding: 10px; text-align: center; color: #888; font-style: italic;">
            Chưa có bài học nào
          </li>
        `;
      }

      html += '</ul></li>';
    });

    chaptersList.innerHTML = html;
    console.log('DEBUG: Rendered chapters list with', chuongsData.length, 'chapters');
  }

  // Hiển thị bài đầu tiên mặc định
  window.onload = function() {
    // Update currentLopHocPhanId from ViewBag
    currentLopHocPhanId = @(ViewBag.IdLopHocPhan ?? 1);
    console.log('DEBUG: currentLopHocPhanId updated to =', currentLopHocPhanId);

    // Render sidebar trước
    renderChaptersList();

    // Chỉ hiển thị bài đầu tiên nếu có dữ liệu
    const firstChapterBais = chuongsData && chuongsData.length > 0 ? (chuongsData[0].bais || chuongsData[0].Bais) : null;
    if (chuongsData && chuongsData.length > 0 && firstChapterBais && firstChapterBais.length > 0) {
      showLesson(0, 0);
    } else {
      // Hiển thị thông báo khi không có bài học
      document.getElementById('tab-lessons').innerHTML = `
        <div style="padding: 40px; text-align: center; color: #666;">
          <i class="fas fa-book-open" style="font-size: 48px; margin-bottom: 16px; display: block; color: #ddd;"></i>
          <h3 style="margin-bottom: 8px; color: #666;">Chưa có bài giảng</h3>
          <p style="margin: 0;">Lớp học này chưa có chương và bài giảng nào được tạo.</p>
        </div>
      `;
    }

    // Khởi tạo pagination HTML
    updatePaginationHtml();

    // Khởi tạo thông tin sinh viên
    updateStudentsInfo();

    // Auto-refresh students list every 30 seconds if on students tab
    setInterval(() => {
      const studentsTab = document.getElementById('tab-students');
      if (studentsTab && studentsTab.style.display !== 'none') {
        refreshStudentsList();
      }
    }, 30000);

    // Clear notifications content ban đầu
    clearNotificationsContent();

    // Khởi tạo SignalR connection để nhận thông báo real-time
    console.log('DEBUG: Initializing SignalR connection');
    connectNotificationHub();
  };

  // Function để refresh danh sách sinh viên
  function refreshStudentsList(page = currentStudentPage) {
    console.log('Refreshing students list for class:', currentLopHocPhanId, 'page:', page);

    fetch(`/User/ChiTietHocPhan/GetStudentsList?idLopHocPhan=${currentLopHocPhanId}&page=${page}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateStudentsTable(data.data);
          updatePagination(data.pagination);
        } else {
          console.error('Failed to refresh students list:', data.message);
        }
      })
      .catch(error => {
        console.error('Error refreshing students list:', error);
      });
  }

  // Function để xử lý chuyển trang sinh viên
  function changeStudentPage(page) {
    console.log('Changing to page:', page);

    if (page < 1 || page > totalStudentPages) {
      console.log('Invalid page number:', page);
      return;
    }

    currentStudentPage = page;
    refreshStudentsList(page);
  }

  // Function để cập nhật thông tin phân trang
  function updatePagination(paginationData) {
    if (paginationData) {
      currentStudentPage = paginationData.currentPage;
      totalStudentPages = paginationData.totalPages;
      totalStudents = paginationData.totalStudents;

      console.log('Updated pagination info:', paginationData);

      // Cập nhật pagination HTML
      updatePaginationHtml();

      // Cập nhật thông tin sinh viên
      updateStudentsInfo();
    }
  }

  // Function để cập nhật thông tin số lượng sinh viên
  function updateStudentsInfo() {
    const infoElement = document.getElementById('studentsInfo');
    if (infoElement && totalStudents > 0) {
      const startIndex = (currentStudentPage - 1) * @(ViewBag.PageSize ?? 1) + 1;
      const endIndex = Math.min(currentStudentPage * @(ViewBag.PageSize ?? 1), totalStudents);
      infoElement.innerHTML = `Hiển thị ${startIndex}-${endIndex} trong tổng số ${totalStudents} sinh viên`;
    } else if (infoElement) {
      infoElement.innerHTML = '';
    }
  }

  // Function để cập nhật HTML phân trang
  function updatePaginationHtml() {
    const paginationContainer = document.getElementById('studentsPagination');

    // Ẩn pagination nếu không có sinh viên hoặc có lỗi
    if (totalStudentPages <= 0) {
      paginationContainer.style.display = 'none';
      return;
    }

    paginationContainer.style.display = 'block';

    let paginationHtml = '<div class="pagination">';

    // Previous button
    if (currentStudentPage > 1) {
      paginationHtml += `<button class="btn-page" onclick="changeStudentPage(${currentStudentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
    } else {
      paginationHtml += `<button class="btn-page" disabled><i class="fas fa-chevron-left"></i></button>`;
    }

    // Page numbers
    for (let i = 1; i <= totalStudentPages; i++) {
      const activeClass = i === currentStudentPage ? ' active' : '';
      paginationHtml += `<button class="btn-page${activeClass}" onclick="changeStudentPage(${i})">${i}</button>`;
    }

    // Next button
    if (currentStudentPage < totalStudentPages) {
      paginationHtml += `<button class="btn-page" onclick="changeStudentPage(${currentStudentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
    } else {
      paginationHtml += `<button class="btn-page" disabled><i class="fas fa-chevron-right"></i></button>`;
    }

    paginationHtml += '</div>';

    paginationContainer.innerHTML = paginationHtml;
  }

  // Function để update students table với data mới
  function updateStudentsTable(students) {
    const tableBody = document.getElementById('studentsTableBody');
    const userRole = '@userRole';

    if (!students || students.length === 0) {
      let emptyMessage = 'Chưa có sinh viên nào trong lớp học này';
      if (totalStudents > 0) {
        emptyMessage = `Không có sinh viên nào trong trang ${currentStudentPage}`;
      }

      tableBody.innerHTML = `
        <tr>
          <td colspan="${userRole !== "Sinhvien" ? "8" : "7"}" style="text-align: center; padding: 20px; color: #666;">
            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
            ${emptyMessage}
            ${userRole !== "Sinhvien" && totalStudents === 0 ? `
              <div style="margin-top: 12px;">
                <button onclick="openInviteStudentModal()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                  <i class="fas fa-plus"></i> Mời sinh viên tham gia
                </button>
              </div>
            ` : ''}
          </td>
        </tr>`;

      // Clear search result info when no students
      const resultInfo = document.getElementById('searchResultInfo');
      if (resultInfo) {
        resultInfo.style.display = 'none';
      }
      return;
    }

    tableBody.innerHTML = students.map(student => `
      <tr>
        <td>${student.tenDangNhap || 'N/A'}</td>
        <td>${student.hoTen || 'N/A'}</td>
        <td>${student.vaiTro === "Sinhvien" ? "Sinh viên" : student.vaiTro}</td>
        <td>${student.email || 'N/A'}</td>
        <td>${student.soDienThoai || 'Chưa cập nhật'}</td>
        <td>
          <img style="width:52px; height:52px; border-radius:50%;" 
               src="${student.anhDaiDien || '/images/avatar.jpg'}" 
               class="student-avatar" />
        </td>
        <td><span class="status-badge ${student.trangThai === 'HoatDong' ? 'hoatdong' : ''}">${student.trangThai === 'HoatDong' ? 'Hoạt động' : (student.trangThai || 'Chưa cập nhật')}</span></td>
        ${userRole !== "Sinhvien" ? `
          <td>
            <button class="btn-icon" onclick="openEditStudentModal(this)"><i class="fas fa-edit"></i></button>
            <button class="btn-icon" onclick="openConfirmDeleteStudentModal(this)"><i class="fas fa-trash"></i></button>
          </td>
        ` : ''}
      </tr>
    `).join('');

    console.log(`Updated students table with ${students.length} students`);

    // Reapply current search filter after updating table
    const searchInput = document.getElementById('studentSearchInput');
    if (searchInput && searchInput.value.trim()) {
      const currentSearchTerm = searchInput.value.trim();
      console.log('Reapplying search filter:', currentSearchTerm);
      setTimeout(() => {
        searchStudentsInList(currentSearchTerm);
      }, 100);
    }
  }

  function showLesson(chapterIdx, lessonIdx) {
    console.log('DEBUG showLesson called for chapter:', chapterIdx, 'lesson:', lessonIdx);

    // Kiểm tra xem tab lessons có đang active không
    const lessonsTab = document.getElementById('tab-lessons');
    if (!lessonsTab) {
      console.error('tab-lessons element not found');
      return;
    }

    // Kiểm tra dữ liệu hợp lệ từ chuongsData - hỗ trợ cả PascalCase và camelCase
    const chuong = chuongsData && chuongsData[chapterIdx] ? chuongsData[chapterIdx] : null;
    const baisList = chuong ? (chuong.bais || chuong.Bais) : null;
    const bai = baisList && baisList[lessonIdx] ? baisList[lessonIdx] : null;

    if (!chuong || !baisList || baisList.length === 0 || !bai) {
      lessonsTab.innerHTML = `
        <div style="padding: 40px; text-align: center; color: #666;">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; display: block; color: #ffa500;"></i>
          <h3 style="margin-bottom: 8px; color: #666;">Không tìm thấy bài học</h3>
          <p style="margin: 0;">Bài học này không tồn tại hoặc đã bị xóa.</p>
        </div>
      `;
      return;
    }

    // Cập nhật trạng thái active cho các button
    document.querySelectorAll('.lesson-btn').forEach(btn => btn.classList.remove('active'));
    const chapters = document.querySelectorAll('.chapter');
    if (chapters[chapterIdx]) {
      const lessonBtns = chapters[chapterIdx].querySelectorAll('.lesson-btn');
      if (lessonBtns[lessonIdx]) {
        lessonBtns[lessonIdx].classList.add('active');
      }
    }

    console.log('DEBUG showLesson - chuong:', chuong);
    console.log('DEBUG showLesson - bai:', bai);

    // Lấy properties hỗ trợ cả PascalCase và camelCase
    const tenChuong = chuong.tenChuong || chuong.TenChuong || 'Chương';
    const tieuDeBai = bai.tieuDeBai || bai.TieuDeBai || 'Tiêu đề bài học';
    const noiDungText = bai.noiDungText || bai.NoiDungText || '';
    const ngayTao = (bai.ngayTao || bai.NgayTao) ? new Date(bai.ngayTao || bai.NgayTao).toLocaleDateString('vi-VN') : 'Chưa cập nhật';

    lessonsTab.innerHTML = `
        <div class="lesson-header">
            <h1>${tieuDeBai}</h1>
            <div class="lesson-meta">Chương: ${tenChuong} | Ngày tạo: ${ngayTao}</div>
        </div>
        <div class="lesson-body">
            <div class="lesson-materials">
                <h4>Tài liệu bài giảng</h4>
                <ul>
                    <li><i class="fas fa-file-text"></i> <a href="#" onclick="alert('Chức năng đang phát triển')">Nội dung bài học</a> <span class="file-size">Text</span></li>
                </ul>
            </div>
            <div class="lesson-desc">
                <h4>Nội dung bài học</h4>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                    ${noiDungText ? noiDungText.replace(/\n/g, '<br>') : 'Chưa có nội dung cho bài học này.'}
                </div>
            </div>
        </div>
        <div class="comments-section">
            <h2>Bình luận</h2>
            <form class="comment-form" onsubmit="event.preventDefault(); addComment();">
                <textarea id="commentText" placeholder="Viết bình luận của bạn..." required></textarea>
                <button type="submit">Gửi</button>
            </form>
            <div class="comments-list" id="commentsList">
                <div class="comment">
                    <img src="@currentUserAvatar" alt="User Avatar" class="comment-avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <h4>Nguyễn Văn A</h4>
                            <span class="comment-time">2 giờ trước</span>
                        </div>
                        <p>Bài giảng rất hay và dễ hiểu. Cảm ơn thầy!</p>
                    </div>
                </div>
            </div>
        </div>
    `;
  }

  // Mở/đóng chương
  function toggleChapter(btn) {
    const li = btn.parentElement;
    li.classList.toggle('open');
    document.querySelectorAll('.chapter-title').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  // Tab switching for course detail
  function showTab(tab, btn) {
    console.log('DEBUG: showTab called with tab =', tab);

    // Remove active class from all tab buttons
    document.querySelectorAll('.course-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Hide all tab contents first
    document.querySelectorAll('.course-tab-content').forEach(c => {
      c.style.display = 'none';
    });

    // Show the selected tab
    const targetTab = document.getElementById('tab-' + tab);
    if (targetTab) {
      targetTab.style.display = 'block';
      console.log('DEBUG: Displayed tab-' + tab);
    } else {
      console.error('DEBUG: Tab not found: tab-' + tab);
    }

    // Handle sidebar visibility
    var sidebar = document.querySelector('.sidebar-chapters');
    if (sidebar) {
      if (tab === 'lessons') {
        sidebar.style.display = 'block';
      } else {
        sidebar.style.display = 'none';
      }
    }

    // Load specific content for each tab
    switch (tab) {
      case 'lessons':
        console.log('DEBUG: Loading lessons content');
        // Lessons content is already loaded on page load
        clearNotificationsContent(); // Clear notifications when switching away
        break;
      case 'students':
        console.log('DEBUG: Loading students content');
        // Students content is already loaded, but we can refresh if needed
        clearNotificationsContent(); // Clear notifications when switching away
        break;
      case 'notices':
        console.log('DEBUG: Loading notifications content');
        // Load notifications ngay lập tức khi switch sang tab
        setTimeout(() => {
          loadNotifications(currentLopHocPhanId);
        }, 50); // Delay nhỏ để đảm bảo DOM đã update
        break;
      default:
        console.log('DEBUG: Unknown tab:', tab);
        clearNotificationsContent(); // Clear notifications when switching away
        break;
    }
  }

  // Function wrapper để tìm kiếm với loại được chọn
  function searchStudentWithType(query) {
    console.log('DEBUG searchStudentWithType called:', query);
    const searchTypeElement = document.getElementById('searchType');

    if (!searchTypeElement) {
      console.error('searchType element not found!');
      return;
    }

    const searchType = searchTypeElement.value;
    console.log('DEBUG search type:', searchType);
    searchStudent(query, searchType);
  }

  // Popup mời học viên
  function openInviteStudentModal() {
    console.log('DEBUG: Opening invite student modal');
    const modal = document.getElementById('inviteStudentModal');
    if (!modal) {
      console.error('inviteStudentModal not found!');
      return;
    }

    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';

    const searchInput = document.getElementById('searchStudentEmail');
    const searchResults = document.getElementById('searchResults');

    if (!searchInput) {
      console.error('searchStudentEmail input not found!');
      return;
    }

    if (!searchResults) {
      console.error('searchResults container not found!');
      return;
    }

    searchInput.value = '';
    searchResults.innerHTML = '';
    selectedStudentsForInvite = []; // Reset selected students
    updateSelectedStudentsDisplay();

    console.log('DEBUG: Modal opened successfully');
  }

  function closeInviteStudentModal() {
    const modal = document.getElementById('inviteStudentModal');
    modal.style.display = 'none';
    modal.style.visibility = 'hidden';
    modal.style.opacity = '0';
    selectedStudentsForInvite = []; // Reset selected students when closing
    updateSelectedStudentsDisplay();
  }

  // Advanced search function with multiple search types
  function searchStudent(query, searchType = 'all') {
    console.log('DEBUG searchStudent called:', {
      query,
      searchType
    });
    const resultsContainer = document.getElementById('searchResults');

    if (!resultsContainer) {
      console.error('searchResults container not found!');
      return;
    }

    if (!query.trim()) {
      resultsContainer.innerHTML = '';
      return;
    }

    // Hiển thị loading
    resultsContainer.innerHTML = '<div style="padding:12px; color:#666; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Đang tìm kiếm...</div>';

    // Call API để tìm kiếm sinh viên với nhiều tiêu chí
    const url = `/User/ChiTietHocPhan/SearchStudents?searchTerm=${encodeURIComponent(query)}&searchType=${searchType}`;
    console.log('DEBUG API URL:', url);

    fetch(url)
      .then(response => {
        console.log('DEBUG API Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('DEBUG API Response data:', data);

        if (!data.success) {
          resultsContainer.innerHTML = `<div style="padding:12px; color:#e74c3c; text-align:center;">${data.message}</div>`;
          return;
        }

        if (!data.data || data.data.length === 0) {
          resultsContainer.innerHTML = '<div style="padding:12px; color:#666; text-align:center;">Không tìm thấy sinh viên</div>';
          return;
        }

        console.log('DEBUG Found students:', data.data.length);

        resultsContainer.innerHTML = data.data.map(student => {
          const isSelected = selectedStudentsForInvite.some(s => s.idTaiKhoan === student.idTaiKhoan);
          return `
            <div class="search-result-item ${isSelected ? 'selected' : ''}" onclick="toggleStudentSelection(${student.idTaiKhoan}, '${student.email.replace(/'/g, "\\'")}', '${student.hoTen.replace(/'/g, "\\'")}', '${(student.anhDaiDien || '/images/avatar.jpg').replace(/'/g, "\\'")}'); event.stopPropagation();" style="padding:12px; display:flex; align-items:center; gap:12px; cursor:pointer; border-radius:6px; margin-bottom:4px; transition:all 0.2s; border: 2px solid ${isSelected ? '#2196F3' : 'transparent'}; background: ${isSelected ? '#e3f2fd' : 'transparent'};" onmouseover="if(!this.classList.contains('selected')) this.style.background='#f5f5f5'" onmouseout="if(!this.classList.contains('selected')) this.style.background='transparent'">
              <div style="width:20px; height:20px; border:2px solid ${isSelected ? '#2196F3' : '#ddd'}; border-radius:4px; display:flex; align-items:center; justify-content:center; background:${isSelected ? '#2196F3' : 'white'};">
                ${isSelected ? '<i class="fas fa-check" style="color:white; font-size:12px;"></i>' : ''}
              </div>
              <img src="${student.anhDaiDien || '/images/avatar.jpg'}" alt="${student.hoTen}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
              <div style="flex:1;">
                <div style="font-weight:500; color:#333;">${student.hoTen}</div>
                <div style="font-size:0.85rem; color:#666;">${student.email}</div>
                <div style="font-size:0.8rem; color:#999;">${student.tenDangNhap} | ${student.soDienThoai || 'Chưa có SĐT'}</div>
              </div>
              <div style="font-size:0.8rem; color:${student.trangThai === 'HoatDong' ? '#27ae60' : '#e74c3c'};">
                ${student.trangThai === 'HoatDong' ? 'Hoạt động' : 'Tạm khóa'}
              </div>
            </div>
          `;
        }).join('');
      })
      .catch(error => {
        console.error('Error searching students:', error);
        resultsContainer.innerHTML = `<div style="padding:12px; color:#e74c3c; text-align:center;">Lỗi tìm kiếm: ${error.message}</div>`;
      });
  }

  // Function để cập nhật placeholder dựa trên loại tìm kiếm được chọn
  function updateSearchPlaceholder() {
    const searchType = document.getElementById('searchType').value;
    const searchInput = document.getElementById('searchStudentEmail');

    const placeholders = {
      'all': 'Tìm kiếm sinh viên...',
      'email': 'Nhập email sinh viên...',
      'name': 'Nhập họ tên sinh viên...',
      'username': 'Nhập tên đăng nhập...',
      'phone': 'Nhập số điện thoại...'
    };

    searchInput.placeholder = placeholders[searchType] || placeholders['all'];

    // Nếu có query hiện tại, tìm kiếm lại với loại mới
    const currentQuery = searchInput.value.trim();
    if (currentQuery) {
      searchStudentWithType(currentQuery);
    }
  }

  function toggleStudentSelection(idTaiKhoan, email, name, avatar) {
    const existingIndex = selectedStudentsForInvite.findIndex(s => s.idTaiKhoan === idTaiKhoan);

    if (existingIndex >= 0) {
      // Remove from selection
      selectedStudentsForInvite.splice(existingIndex, 1);
      console.log('Removed student from selection:', name);
    } else {
      // Add to selection
      selectedStudentsForInvite.push({
        idTaiKhoan,
        email,
        name,
        avatar
      });
      console.log('Added student to selection:', name);
    }

    // Update display
    updateSelectedStudentsDisplay();

    // Refresh search results to update checkboxes
    const searchQuery = document.getElementById('searchStudentEmail').value;
    if (searchQuery.trim()) {
      searchStudentWithType(searchQuery);
    }

    console.log('Selected students:', selectedStudentsForInvite);
  }

  function updateSelectedStudentsDisplay() {
    const container = document.getElementById('selectedStudentsContainer');
    const list = document.getElementById('selectedStudentsList');

    // Update count in footer
    const countElement = document.getElementById('selectedCountNumber');
    const inviteButton = document.getElementById('inviteButton');

    if (countElement) {
      countElement.textContent = selectedStudentsForInvite.length;
    }

    if (inviteButton) {
      if (selectedStudentsForInvite.length > 0) {
        inviteButton.disabled = false;
        inviteButton.style.background = '#007bff';
        inviteButton.style.cursor = 'pointer';
        inviteButton.textContent = `Mời (${selectedStudentsForInvite.length})`;
      } else {
        inviteButton.disabled = true;
        inviteButton.style.background = '#ccc';
        inviteButton.style.cursor = 'not-allowed';
        inviteButton.textContent = 'Mời';
      }
    }

    if (selectedStudentsForInvite.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    list.innerHTML = selectedStudentsForInvite.map((student, index) => `
      <div style="display:flex; align-items:center; gap:8px; padding:6px; border-bottom:1px solid #f0f0f0; ${index === selectedStudentsForInvite.length - 1 ? 'border-bottom:none;' : ''}">
        <img src="${student.avatar || '/images/avatar.jpg'}" alt="${student.name}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
        <div style="flex:1; font-size:0.85rem;">
          <div style="font-weight:500; color:#333;">${student.name}</div>
          <div style="color:#666;">${student.email}</div>
        </div>
        <button onclick="removeStudentFromSelection(${student.idTaiKhoan})" style="background:none; border:none; color:#e74c3c; cursor:pointer; padding:2px; border-radius:3px;" title="Bỏ chọn">
          <i class="fas fa-times" style="font-size:12px;"></i>
        </button>
      </div>
    `).join('');
  }


  function removeStudentFromSelection(idTaiKhoan) {
    selectedStudentsForInvite = selectedStudentsForInvite.filter(s => s.idTaiKhoan !== idTaiKhoan);
    updateSelectedStudentsDisplay();

    // Refresh search results if there's a query
    const searchQuery = document.getElementById('searchStudentEmail').value;
    if (searchQuery.trim()) {
      searchStudentWithType(searchQuery);
    }
  }

  function clearSelectedStudents() {
    selectedStudentsForInvite = [];
    updateSelectedStudentsDisplay();

    // Refresh search results if there's a query
    const searchQuery = document.getElementById('searchStudentEmail').value;
    if (searchQuery.trim()) {
      searchStudentWithType(searchQuery);
    }
  }

  function inviteSelectedStudent() {
    if (!selectedStudentsForInvite || selectedStudentsForInvite.length === 0) {
      alert('Vui lòng chọn ít nhất một sinh viên để mời');
      return;
    }

    // Hiển thị loading
    const inviteBtn = document.getElementById('inviteButton');
    const originalText = inviteBtn.textContent;
    inviteBtn.disabled = true;
    inviteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';
    inviteBtn.style.background = '#6c757d';

    // Debug log trước khi gửi
    console.log('Sending invite request:', {
      idLopHocPhan: currentLopHocPhanId,
      selectedStudents: selectedStudentsForInvite,
      studentCount: selectedStudentsForInvite.length
    });

    // Gửi API để mời nhiều sinh viên (sử dụng FormData cho CSRF token)
    const formData = new FormData();
    formData.append('idLopHocPhan', currentLopHocPhanId);

    // Thêm tất cả ID sinh viên được chọn
    selectedStudentsForInvite.forEach((student, index) => {
      formData.append(`idTaiKhoans[${index}]`, student.idTaiKhoan);
    });

    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');

    fetch('/User/ChiTietHocPhan/InviteStudents', { // Đổi endpoint thành InviteStudents
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Hiển thị thông báo chi tiết hơn
          let message = data.message;
          if (data.details) {
            message += `\n\nChi tiết:`;
            message += `\n- Thành công: ${data.details.successful}`;
            if (data.details.failed > 0) {
              message += `\n- Lỗi: ${data.details.failed}`;
            }
            if (data.details.alreadyMembers > 0) {
              message += `\n- Đã tham gia: ${data.details.alreadyMembers}`;
            }
          }
          alert(`✅ ${message}`);
          closeInviteStudentModal();

          // Refresh students list after successful invite
          setTimeout(() => {
            if (typeof refreshStudentsList === 'function') {
              refreshStudentsList();
            }
          }, 2000);
        } else {
          alert(`❌ ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error inviting students:', error);
        alert('❌ Lỗi khi gửi lời mời');
      })
      .finally(() => {
        inviteBtn.disabled = false;
        inviteBtn.style.background = '#007bff';
        inviteBtn.textContent = originalText;
      });
  }

  function toggleNoticeMenu(btn) {
    // Đóng tất cả menu khác
    document.querySelectorAll('.notice-menu-popup').forEach(p => p.style.display = 'none');
    // Mở menu của thông báo này
    const popup = btn.parentElement.querySelector('.notice-menu-popup');
    if (popup) {
      popup.style.display = 'flex';
      // Đóng khi click ra ngoài
      setTimeout(() => {
        document.addEventListener('mousedown', closeNoticeMenuOnClickOutside);
      }, 0);
    }
  }

  function closeNoticeMenuOnClickOutside(e) {
    if (!e.target.closest('.notice-menu-popup') && !e.target.closest('.notice-menu')) {
      document.querySelectorAll('.notice-menu-popup').forEach(p => p.style.display = 'none');
      document.removeEventListener('mousedown', closeNoticeMenuOnClickOutside);
    }
  }

  function addNotice() {
    document.getElementById('addNoticeModal').style.display = 'flex';
    document.getElementById('addNoticeModal').style.alignItems = 'center';
    document.getElementById('addNoticeModal').style.justifyContent = 'center';
    document.getElementById('addNoticeForm').reset();
    document.querySelectorAll('.notice-menu-popup').forEach(p => p.style.display = 'none');
    if (window.CKEDITOR && CKEDITOR.instances.noticeContent) {
      CKEDITOR.instances.noticeContent.destroy(true);
    }
    CKEDITOR.replace('noticeContent');
  }

  function closeAddNoticeModal() {
    document.getElementById('addNoticeModal').style.display = 'none';
  }

  function submitAddNotice(e) {
    e.preventDefault();
    const title = document.getElementById('noticeTitle').value;
    const content = CKEDITOR.instances.noticeContent.getData();
    fetch('/User/ThongBao/AddNotification', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          TieuDe: title,
          NoiDung: content,
          IdLopHocPhan: currentLopHocPhanId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          closeAddNoticeModal();
        } else {
          alert('❌ ' + data.message);
        }
      });
  }

  let currentEditNoticeCard = null;
  let currentDeleteNoticeCard = null;

  function editNotice(btn) {
    currentEditNoticeCard = btn.closest('.notice-card');
    // Lấy HTML nội dung cũ
    const htmlContent = currentEditNoticeCard.querySelector('.notice-body div')?.innerHTML || '';
    let title = '';
    let content = htmlContent;

    // Tạo thẻ tạm để parse HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;

    // Lấy dòng đầu tiên (có thể là <p> hoặc text)
    let firstText = '';
    if (tempDiv.firstChild && tempDiv.firstChild.nodeType === 1 && tempDiv.firstChild.tagName === 'P') {
      firstText = tempDiv.firstChild.innerText.trim();
      title = firstText;
      // Xóa dòng tiêu đề khỏi nội dung
      tempDiv.removeChild(tempDiv.firstChild);
      content = tempDiv.innerHTML.trim();
    } else if (tempDiv.firstChild && tempDiv.firstChild.nodeType === 3) {
      // Nếu là text node
      firstText = tempDiv.firstChild.textContent.trim();
      title = firstText;
      tempDiv.removeChild(tempDiv.firstChild);
      content = tempDiv.innerHTML.trim();
    } else {
      // Nếu không có <p>, lấy toàn bộ text đầu tiên
      const match = htmlContent.match(/^(.+?)<br\s*\/?>([\\s\\S]*)/i);
      if (match) {
        title = match[1].trim();
        content = match[2].trim();
      }
    }

    document.getElementById('editNoticeTitle').value = title;
    // Destroy CKEditor instance nếu đã tồn tại
    if (window.CKEDITOR && CKEDITOR.instances.editNoticeContent) {
      CKEDITOR.instances.editNoticeContent.destroy(true);
    }
    // Khởi tạo lại CKEditor cho textarea
    CKEDITOR.replace('editNoticeContent');
    CKEDITOR.instances.editNoticeContent.on('instanceReady', function() {
      CKEDITOR.instances.editNoticeContent.setData(content);
    });
    document.getElementById('editNoticeModal').style.display = 'flex';
    document.getElementById('editNoticeModal').style.alignItems = 'center';
    document.getElementById('editNoticeModal').style.justifyContent = 'center';
    document.getElementById('editNoticeForm').reset();
    document.querySelectorAll('.notice-menu-popup').forEach(p => p.style.display = 'none');
  }

  function closeEditNoticeModal() {
    document.getElementById('editNoticeModal').style.display = 'none';
  }

  function submitEditNotice(e) {
    e.preventDefault();
    const title = document.getElementById('editNoticeTitle').value;
    const content = CKEDITOR.instances.editNoticeContent.getData();
    const id = currentEditNoticeCard?.getAttribute('data-id');
    if (!id) {
      alert('Không xác định được thông báo để sửa!');
      return;
    }
    fetch('/User/ThongBao/EditNotification', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          IdThongBao: id,
          TieuDe: title,
          NoiDung: content
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          closeEditNoticeModal();
        } else {
          alert('❌ ' + data.message);
        }
      });
  }

  function deleteNotice(btn) {
    currentDeleteNoticeCard = btn.closest('.notice-card');
    document.getElementById('confirmDeleteNoticeModal').style.display = 'flex';
    document.getElementById('confirmDeleteNoticeModal').style.alignItems = 'center';
    document.getElementById('confirmDeleteNoticeModal').style.justifyContent = 'center';
    document.querySelectorAll('.notice-menu-popup').forEach(p => p.style.display = 'none');
  }

  function closeConfirmDeleteNoticeModal() {
    document.getElementById('confirmDeleteNoticeModal').style.display = 'none';
  }

  function confirmDeleteNotice() {
    if (currentDeleteNoticeCard) {
      currentDeleteNoticeCard.remove();
      currentDeleteNoticeCard = null;
    }
    closeConfirmDeleteNoticeModal();
  }

  let currentEditStudentId = null;

  function openEditStudentModal(btn) {
    const row = btn.closest('tr');
    const cells = row.children;

    // Lấy ID sinh viên từ data attribute hoặc parse từ table
    const username = cells[0]?.innerText?.trim();
    const email = cells[3]?.innerText?.trim();

    // Tìm sinh viên bằng email để lấy ID
    if (!email) {
      alert('Không thể xác định sinh viên để chỉnh sửa');
      return;
    }

    // Hiển thị loading trong modal
    document.getElementById('editStudentModal').style.display = 'flex';
    document.getElementById('editStudentModal').style.alignItems = 'center';
    document.getElementById('editStudentModal').style.justifyContent = 'center';

    const modalContent = document.querySelector('#editStudentModal .modal-content');
    modalContent.innerHTML = '<div style="padding:40px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Đang tải thông tin sinh viên...</div>';

    // Tìm sinh viên theo email để lấy thông tin đầy đủ
    fetch(`/User/ChiTietHocPhan/SearchStudents?searchTerm=${encodeURIComponent(email)}&searchType=email`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.data && data.data.length > 0) {
          const student = data.data[0]; // Lấy sinh viên đầu tiên
          currentEditStudentId = student.idTaiKhoan;

          // Hiển thị form chỉnh sửa
          modalContent.innerHTML = `
            <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e6ed; padding-bottom:18px; margin-bottom:24px;">
              <h2 style="font-size:1.35rem; font-weight:700; color:#22334d; margin:0;">Chỉnh sửa sinh viên</h2>
              <button onclick="closeEditStudentModal()" style="background:none; border:none; font-size:1.3rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <form id="editStudentForm" onsubmit="submitEditStudent(event)">
              <div class="form-group">
                <label for="editStudentUsername">Tên đăng nhập</label>
                <input type="text" id="editStudentUsername" value="${student.tenDangNhap || ''}" readonly style="background:#f5f5f5; color:#666;">
              </div>
              <div class="form-group">
                <label for="editStudentName">Họ và tên *</label>
                <input type="text" id="editStudentName" value="${student.hoTen || ''}" required>
              </div>
              <div class="form-group">
                <label for="editStudentEmail">Email *</label>
                <input type="email" id="editStudentEmail" value="${student.email || ''}" required>
              </div>
              <div class="form-group">
                <label for="editStudentPhone">Số điện thoại</label>
                <input type="text" id="editStudentPhone" value="${student.soDienThoai || ''}">
              </div>
              <div class="form-group">
                <label>Trạng thái hiện tại</label>
                <div style="padding:8px; background:${student.trangThai === 'HoatDong' ? '#d4edda' : '#f8d7da'}; border-radius:4px; color:${student.trangThai === 'HoatDong' ? '#155724' : '#721c24'};">
                  ${student.trangThai === 'HoatDong' ? 'Hoạt động' : 'Tạm khóa'}
                </div>
              </div>
              <div class="form-actions modal-actions">
                <button type="button" onclick="closeEditStudentModal()" class="btn-cancel">Hủy</button>
                <button type="submit" class="btn-primary">Lưu thay đổi</button>
              </div>
            </form>
          `;
        } else {
          modalContent.innerHTML = `
            <div style="padding:40px; text-align:center; color:#e74c3c;">
              <i class="fas fa-exclamation-triangle" style="font-size:48px; margin-bottom:16px;"></i>
              <h3>Không tìm thấy sinh viên</h3>
              <button onclick="closeEditStudentModal()" class="btn-primary" style="margin-top:16px;">Đóng</button>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error loading student info:', error);
        modalContent.innerHTML = `
          <div style="padding:40px; text-align:center; color:#e74c3c;">
            <i class="fas fa-exclamation-triangle" style="font-size:48px; margin-bottom:16px;"></i>
            <h3>Lỗi tải thông tin sinh viên</h3>
            <p>${error.message}</p>
            <button onclick="closeEditStudentModal()" class="btn-primary" style="margin-top:16px;">Đóng</button>
          </div>
        `;
      });
  }

  function closeEditStudentModal() {
    document.getElementById('editStudentModal').style.display = 'none';
    currentEditStudentId = null;
  }

  function submitEditStudent(e) {
    e.preventDefault();

    if (!currentEditStudentId) {
      alert('Không xác định được sinh viên để cập nhật');
      return;
    }

    const formData = new FormData();
    formData.append('idTaiKhoan', currentEditStudentId);
    formData.append('hoTen', document.getElementById('editStudentName').value.trim());
    formData.append('email', document.getElementById('editStudentEmail').value.trim());
    formData.append('soDienThoai', document.getElementById('editStudentPhone').value.trim());
    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');

    // Hiển thị loading
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

    fetch('/User/ChiTietHocPhan/UpdateStudent', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('✅ ' + data.message);
          closeEditStudentModal();
          refreshStudentsList(); // Refresh danh sách sinh viên
        } else {
          alert('❌ ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error updating student:', error);
        alert('❌ Lỗi cập nhật sinh viên: ' + error.message);
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
  }



  let currentDeleteStudentRow = null;

  function openConfirmDeleteStudentModal(btn) {
    currentDeleteStudentRow = btn.closest('tr');
    document.getElementById('confirmDeleteStudentModal').style.display = 'flex';
    document.getElementById('confirmDeleteStudentModal').style.alignItems = 'center';
    document.getElementById('confirmDeleteStudentModal').style.justifyContent = 'center';
  }

  function closeConfirmDeleteStudentModal() {
    document.getElementById('confirmDeleteStudentModal').style.display = 'none';
  }

  function confirmDeleteStudent() {
    if (!currentDeleteStudentRow) {
      alert('Không xác định được sinh viên để xóa');
      return;
    }

    const cells = currentDeleteStudentRow.children;
    const email = cells[3]?.innerText?.trim();

    if (!email) {
      alert('Không thể xác định sinh viên để xóa');
      return;
    }

    // Tìm sinh viên theo email để lấy ID
    fetch(`/User/ChiTietHocPhan/SearchStudents?searchTerm=${encodeURIComponent(email)}&searchType=email`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.data && data.data.length > 0) {
          const student = data.data[0];
          const studentId = student.idTaiKhoan;

          // Gọi API để xóa sinh viên khỏi lớp
          const formData = new FormData();
          formData.append('idLopHocPhan', currentLopHocPhanId);
          formData.append('idTaiKhoan', studentId);
          formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');

          fetch('/User/ChiTietHocPhan/RemoveStudentFromClass', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('✅ ' + data.message);
                closeConfirmDeleteStudentModal();
                refreshStudentsList(); // Refresh danh sách sinh viên
              } else {
                alert('❌ ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error removing student:', error);
              alert('❌ Lỗi xóa sinh viên: ' + error.message);
            });
        } else {
          alert('❌ Không tìm thấy thông tin sinh viên');
        }
      })
      .catch(error => {
        console.error('Error finding student:', error);
        alert('❌ Lỗi tìm kiếm sinh viên: ' + error.message);
      });
  }

  function loadNotifications(idLopHocPhan, page = 1) {
    console.log('Loading notifications for class:', idLopHocPhan);

    // Chỉ load khi đang ở tab thông báo
    if (!isCurrentTabNotices()) {
      console.log('Not on notifications tab, skipping load');
      hasUnloadedNotifications = true;
      return;
    }

    const noticesContainer = document.getElementById('tab-notices');
    if (!noticesContainer) {
      console.error('tab-notices container not found!');
      return;
    }

    // Hiển thị loading spinner
    noticesContainer.innerHTML = `
      <div style="padding: 40px; text-align: center; color: #666;">
        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
        Đang tải thông báo...
      </div>
    `;

    fetch(`/User/ThongBao/GetNotifications?idLopHocPhan=${idLopHocPhan}&page=${page}`)
      .then(res => res.json())
      .then(data => {
        console.log('Notifications API response:', data);

        // Kiểm tra lại xem có còn ở tab thông báo không
        if (!isCurrentTabNotices()) {
          console.log('Tab switched during API call, not rendering');
          return;
        }

        if (data.success) {
          console.log('Notifications data:', data.data);
          if (data.data && data.data.length > 0) {
            data.data.forEach((notification, index) => {
              console.log(`Notification ${index}:`, {
                id: notification.idThongBao,
                author: notification.tenGiangVien,
                avatar: notification.avatar,
                content: notification.noiDung
              });
            });
          }
          renderNotifications(data.data);
          // Reset flag sau khi load thành công
          hasUnloadedNotifications = false;
        } else {
          noticesContainer.innerHTML = `
            <div style="padding: 40px; text-align: center; color: #e74c3c;">
              <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
              <h3 style="margin-bottom: 8px;">Lỗi tải thông báo</h3>
              <p style="margin: 0;">${data.message || 'Không thể tải thông báo'}</p>
              <div style="margin-top: 16px;">
                <button onclick="loadNotifications(${idLopHocPhan})" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                  <i class="fas fa-redo"></i> Thử lại
                </button>
              </div>
            </div>
          `;
        }
      })
      .catch(err => {
        console.error('Error loading notifications:', err);

        // Kiểm tra lại xem có còn ở tab thông báo không
        if (!isCurrentTabNotices()) {
          console.log('Tab switched during API call, not showing error');
          return;
        }

        noticesContainer.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #e74c3c;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
            <h3 style="margin-bottom: 8px;">Lỗi kết nối</h3>
            <p style="margin: 0;">Không thể kết nối đến server để tải thông báo</p>
            <div style="margin-top: 16px;">
              <button onclick="loadNotifications(${idLopHocPhan})" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-redo"></i> Thử lại
              </button>
            </div>
          </div>
        `;
      });
  }

  function renderNotifications(notifications) {
    const userRole = '@userRole';
    const isNotStudent = !userRole || userRole.toLowerCase() !== 'sinhvien';
    const currentUserAvatar = '@currentUserAvatar';
    const container = document.getElementById('tab-notices');

    if (!container) {
      console.error('tab-notices container not found!');
      return;
    }

    // Đảm bảo chỉ render khi đang ở tab thông báo
    if (!isCurrentTabNotices()) {
      console.log('Not on notifications tab, skipping render');
      return;
    }

    if (!notifications || notifications.length === 0) {
      container.innerHTML = `
        <div style="padding: 40px; text-align: center; color: #666;">
          <i class="fas fa-bell" style="font-size: 48px; margin-bottom: 16px; display: block; color: #ddd;"></i>
          <h3 style="margin-bottom: 8px; color: #666;">Chưa có thông báo nào</h3>
          <p style="margin: 0;">Lớp học này chưa có thông báo nào được tạo.</p>
          ${isNotStudent ? `
            <div style="margin-top: 20px;">
              <button onclick="addNotice()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-plus"></i> Thêm thông báo đầu tiên
              </button>
            </div>
          ` : ''}
        </div>
      `;
      return;
    }

    // Header với nút thêm thông báo
    let headerHtml = '';
    if (isNotStudent) {
      headerHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 20px;">
          <h3 style="margin: 0; color: #333;">Thông báo lớp học</h3>
          <button onclick="addNotice()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            <i class="fas fa-plus"></i> Thêm thông báo
          </button>
        </div>
      `;
    }

    const notificationsHtml = notifications.map(tb => `
      <div class="notice-card" data-id="${tb.idThongBao}">
        <div class="notice-header">
          <img src="${tb.avatar && tb.avatar.trim() !== '' ? tb.avatar : '/images/avatar.jpg'}" alt="Avatar của ${tb.tenGiangVien || 'Người tạo'}" class="notice-avatar" />
          <div class="notice-info">
            <div class="notice-author">${tb.tenGiangVien || 'Không xác định'}</div>
            <div class="notice-time">${tb.ngayTao || ''}</div>
          </div>
          ${isNotStudent ? `
          <button class="notice-menu" onclick="toggleNoticeMenu(this)" title="Tùy chọn">
            <i class="fas fa-ellipsis-v" style="display: inline-block !important;"></i>
          </button>
          <div class="notice-menu-popup" style="display:none; position:absolute; right:24px; top:48px; background:#fff; box-shadow:0 2px 8px rgba(44,62,80,0.12); border-radius:8px; min-width:160px; z-index:10;">
            <button onclick="editNotice(this)" class="notice-menu-item">Sửa thông báo</button>
            <button onclick="deleteNotice(this)" class="notice-menu-item" style="color:#e74c3c;">Xóa thông báo</button>
          </div>
          ` : ''}
        </div>
        <div class="notice-body">
          <div style="white-space:normal;word-break:break-word;overflow-wrap:break-word;">${tb.noiDung || ''}</div>
        </div>
        <div class="notice-comment">
          <img src="${currentUserAvatar}" alt="Avatar của bạn" class="comment-avatar">
          <input type="text" placeholder="Thêm nhận xét trong lớp học...">
          <button class="comment-send"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    `).join('');

    container.innerHTML = headerHtml + notificationsHtml;
  }

  let notificationConnection = null;

  function connectNotificationHub() {
    notificationConnection = new signalR.HubConnectionBuilder()
      .withUrl("/notificationHub")
      .build();
    notificationConnection.on("NewNotification", function(notification) {
      console.log('DEBUG: SignalR NewNotification received');
      // Chỉ load thông báo nếu đang ở tab thông báo
      if (isCurrentTabNotices()) {
        console.log('DEBUG: Currently on notices tab, loading notifications');
        loadNotifications(currentLopHocPhanId);
      } else {
        console.log('DEBUG: Not on notices tab, marking as pending');
        hasUnloadedNotifications = true;
      }
    });
    notificationConnection.on("UpdateNotification", function(notification) {
      console.log('DEBUG: SignalR UpdateNotification received');
      // Chỉ load thông báo nếu đang ở tab thông báo
      if (isCurrentTabNotices()) {
        console.log('DEBUG: Currently on notices tab, loading notifications');
        loadNotifications(currentLopHocPhanId);
      } else {
        console.log('DEBUG: Not on notices tab, marking as pending');
        hasUnloadedNotifications = true;
      }
    });
    notificationConnection.start().then(function() {
      notificationConnection.invoke("JoinClass", currentLopHocPhanId.toString());
    });
  }

  // Function để kiểm tra xem có đang ở tab thông báo không
  function isCurrentTabNotices() {
    const noticesTab = document.getElementById('tab-notices');
    const isVisible = noticesTab && noticesTab.style.display !== 'none' && noticesTab.style.display !== '';
    console.log('DEBUG isCurrentTabNotices:', {
      element: !!noticesTab,
      display: noticesTab ? noticesTab.style.display : 'null',
      isVisible: isVisible
    });
    return isVisible;
  }

  // Function để clear nội dung tab notifications khi chuyển sang tab khác
  function clearNotificationsContent() {
    const noticesContainer = document.getElementById('tab-notices');
    if (noticesContainer) {
      noticesContainer.innerHTML = `
        <div style="padding: 40px; text-align: center; color: #666;">
          <i class="fas fa-bell" style="font-size: 48px; margin-bottom: 16px; display: block; color: #ddd;"></i>
          <h3 style="margin-bottom: 8px; color: #666;">Thông báo</h3>
          <p style="margin: 0;">Vui lòng chọn tab "Thông báo" để xem thông báo của lớp học.</p>
        </div>
      `;
      console.log('DEBUG: Cleared notifications content');
    }
  }

  // Khởi tạo CKEditor khi DOM loaded
  window.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('noticeContent')) {
      CKEDITOR.replace('noticeContent');
    }
    if (document.getElementById('editNoticeContent')) {
      CKEDITOR.replace('editNoticeContent');
    }
  });

  // Hàm thêm bình luận
  function addComment() {
    const commentText = document.getElementById('commentText');
    const commentsList = document.getElementById('commentsList');

    if (!commentText.value.trim()) {
      alert('Vui lòng nhập nội dung bình luận');
      return;
    }

    // Tạo comment mới
    const newComment = document.createElement('div');
    newComment.className = 'comment';
    newComment.innerHTML = `
      <img src="/images/avatar.jpg" alt="User Avatar" class="comment-avatar">
      <div class="comment-content">
        <div class="comment-header">
          <h4>Bạn</h4>
          <span class="comment-time">Vừa xong</span>
        </div>
        <p>${commentText.value}</p>
      </div>
    `;

    // Thêm vào đầu danh sách
    commentsList.insertBefore(newComment, commentsList.firstChild);

    // Reset form
    commentText.value = '';

    // TODO: Gửi comment lên server để lưu vào database
    console.log('Comment added:', commentText.value);
  }

  // Function để tìm kiếm sinh viên trong danh sách hiện tại
  function searchStudentsInList(searchTerm) {
    const tableBody = document.getElementById('studentsTableBody');
    const rows = tableBody.getElementsByTagName('tr');

    console.log('Searching students with term:', searchTerm);

    if (!searchTerm.trim()) {
      // Hiển thị tất cả sinh viên khi không có từ khóa tìm kiếm
      for (let i = 0; i < rows.length; i++) {
        rows[i].style.display = '';
        // Remove highlights
        removeHighlights(rows[i]);
      }
      updateSearchResultInfo(rows.length, rows.length);
      return;
    }

    const searchLower = searchTerm.toLowerCase().trim();
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const cells = row.getElementsByTagName('td');

      // Bỏ qua row empty state
      if (cells.length < 4) {
        continue;
      }

      // Remove previous highlights
      removeHighlights(row);

      // Lấy text từ các cột: tên đăng nhập, họ tên, email
      const username = cells[0]?.textContent?.toLowerCase() || '';
      const fullName = cells[1]?.textContent?.toLowerCase() || '';
      const email = cells[3]?.textContent?.toLowerCase() || '';
      const phone = cells[4]?.textContent?.toLowerCase() || '';

      // Kiểm tra xem có match với từ khóa tìm kiếm không
      const isMatch = username.includes(searchLower) ||
        fullName.includes(searchLower) ||
        email.includes(searchLower) ||
        phone.includes(searchLower);

      if (isMatch) {
        row.style.display = '';
        visibleCount++;
        // Highlight text matches
        highlightSearchTerm(row, searchTerm);
      } else {
        row.style.display = 'none';
      }
    }

    console.log(`Found ${visibleCount} students matching "${searchTerm}"`);
    updateSearchResultInfo(visibleCount, rows.length);
  }

  // Function để highlight text được tìm kiếm
  function highlightSearchTerm(row, searchTerm) {
    if (!searchTerm.trim()) return;

    const cells = row.getElementsByTagName('td');
    const searchLower = searchTerm.toLowerCase();

    // Highlight trong các cột: tên đăng nhập, họ tên, email, số điện thoại
    [0, 1, 3, 4].forEach(cellIndex => {
      if (cells[cellIndex]) {
        const originalText = cells[cellIndex].textContent;
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        const highlightedText = originalText.replace(regex, '<mark style="background-color: #fff3cd; padding: 1px 3px; border-radius: 3px;">$1</mark>');

        if (originalText.toLowerCase().includes(searchLower)) {
          cells[cellIndex].innerHTML = highlightedText;
        }
      }
    });
  }

  // Function để xóa highlight
  function removeHighlights(row) {
    const cells = row.getElementsByTagName('td');
    [0, 1, 3, 4].forEach(cellIndex => {
      if (cells[cellIndex]) {
        const marks = cells[cellIndex].getElementsByTagName('mark');
        while (marks.length > 0) {
          const mark = marks[0];
          mark.outerHTML = mark.innerHTML;
        }
      }
    });
  }

  // Function để cập nhật thông tin kết quả tìm kiếm
  function updateSearchResultInfo(visibleCount, totalCount) {
    // Tìm hoặc tạo element hiển thị thông tin kết quả
    let resultInfo = document.getElementById('searchResultInfo');
    if (!resultInfo) {
      resultInfo = document.createElement('div');
      resultInfo.id = 'searchResultInfo';
      resultInfo.style.cssText = 'padding: 8px 16px; background: #f8f9fa; border-radius: 6px; margin-bottom: 12px; font-size: 0.9rem; color: #666; border-left: 3px solid #007bff;';

      const tableContainer = document.querySelector('.student-table');
      tableContainer.insertBefore(resultInfo, tableContainer.firstChild);
    }

    const searchInput = document.getElementById('studentSearchInput');
    const searchTerm = searchInput ? searchInput.value.trim() : '';

    if (searchTerm) {
      if (visibleCount === 0) {
        resultInfo.innerHTML = `<i class="fas fa-search"></i> Không tìm thấy sinh viên nào với từ khóa "<strong>${searchTerm}</strong>" trong trang ${currentStudentPage}`;
        resultInfo.style.borderLeftColor = '#dc3545';
        resultInfo.style.color = '#dc3545';
      } else {
        resultInfo.innerHTML = `<i class="fas fa-search"></i> Tìm thấy <strong>${visibleCount}</strong> sinh viên với từ khóa "<strong>${searchTerm}</strong>" trong trang ${currentStudentPage} (tổng số ${totalStudents} sinh viên)`;
        resultInfo.style.borderLeftColor = '#28a745';
        resultInfo.style.color = '#28a745';
      }
      resultInfo.style.display = 'block';
    } else {
      resultInfo.style.display = 'none';
    }
  }

  // Function để clear search
  function clearStudentSearch() {
    const searchInput = document.getElementById('studentSearchInput');

    if (searchInput) {
      searchInput.value = '';
      searchStudentsInList('');
    }

    // Focus lại vào search input
    if (searchInput) {
      searchInput.focus();
    }
  }
</script>

@* Handle TempData messages *@
@if (TempData["Success"] != null)
{
<script>
  window.addEventListener('DOMContentLoaded', function() {
    alert('✅ @TempData["Success"]');
    setTimeout(() => {
      if (typeof refreshStudentsList === 'function') {
        refreshStudentsList();
      }
    }, 1000);
  });
</script>
}

@if (TempData["Error"] != null)
{
<script>
  window.addEventListener('DOMContentLoaded', function() {
    alert('❌ @TempData["Error"]');
  });
</script>
}

@if (TempData["Warning"] != null)
{
<script>
  window.addEventListener('DOMContentLoaded', function() {
    alert('⚠️ @TempData["Warning"]');
  });
</script>
}

@if (TempData["Info"] != null)
{
<script>
  window.addEventListener('DOMContentLoaded', function() {
    alert('ℹ️ @TempData["Info"]');
  });
</script>
}