@using System.Security.Claims
@inject Lecture_web.ApplicationDbContext DbContext
@{
var avatar = "/images/avatar.jpg"; // Mặc định
var userName = "User";

// Luôn lấy thông tin user từ database nếu đã đăng nhập
if (User.Identity.IsAuthenticated)
{
try
{
var userId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));
var currentUser = DbContext.TaiKhoan.FirstOrDefault(u => u.IdTaiKhoan == userId);
if (currentUser != null)
{
userName = currentUser.HoTen ?? currentUser.TenDangNhap ?? "User";

// Xử lý đường dẫn avatar
if (!string.IsNullOrEmpty(currentUser.AnhDaiDien))
{
// Nếu đường dẫn đã bắt đầu bằng / thì dùng trực tiếp
if (currentUser.AnhDaiDien.StartsWith("/"))
{
avatar = currentUser.AnhDaiDien;
}
// Nếu không thì thêm /images/ phía trước
else
{
avatar = "/images/" + currentUser.AnhDaiDien;
}
}
}
}
catch
{
userName = "User";
avatar = "/images/avatar.jpg";
}
}

// Override từ ViewBag nếu controller đã set
if (!string.IsNullOrEmpty(ViewBag.UserName as string))
{
userName = (string)ViewBag.UserName;
}
if (!string.IsNullOrEmpty(ViewBag.Avatar as string))
{
avatar = (string)ViewBag.Avatar;
}
}
<header class="top-bar">

  <div class="user-menu">
    <div class="notifications">
      <i class="fas fa-bell"></i>
      <span class="notification-badge">5</span>
    </div>
    <div class="user-profile" onclick="toggleUserMenu()">
      <img src="@avatar?v=@DateTime.Now.Ticks" alt="Avatar @userName" class="avatar" id="topBarAvatar" onerror="this.src='/images/avatar.jpg?v=' + new Date().getTime()">
      <span class="user-name" id="topBarUserName">@userName</span>
      <i class="fas fa-chevron-down"></i>
      <div class="user-dropdown">
        <a href="/profile/profile">
          <i class="fas fa-user"></i>
          Thông tin cá nhân
        </a>
        <a href="#settings">
          <i class="fas fa-cog"></i>
          Cài đặt
        </a>
        <div class="dropdown-divider"></div>
        <a href="/profile/LogOut">
          <i class="fas fa-sign-out-alt"></i>
          Đăng xuất
        </a>
      </div>
    </div>
  </div>
</header>

<script>
  // Ưu tiên lấy avatar mới nhất từ localStorage khi load trang
  document.addEventListener('DOMContentLoaded', function() {
    var updatedUrl = localStorage.getItem('updatedAvatarUrl');
    if (updatedUrl) {
      var topBarAvatar = document.getElementById('topBarAvatar');
      if (topBarAvatar) topBarAvatar.src = updatedUrl + '?t=' + new Date().getTime();
    }
  });
</script>