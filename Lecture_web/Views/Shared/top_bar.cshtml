@using System.Security.Claims
@inject Lecture_web.ApplicationDbContext DbContext
@{

var userName = "Guest";
string avatar = null;
bool hasAvatar = false; // Thêm flag để track có avatar hay không

Console.WriteLine("=== TOP BAR DEBUG START ===");
Console.WriteLine($"User authenticated: {User.Identity.IsAuthenticated}");

if (User.Identity.IsAuthenticated)
{
try
{
var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
var userNameClaim = User.FindFirstValue(ClaimTypes.Name);
var userRoleClaim = User.FindFirstValue(ClaimTypes.Role);

Console.WriteLine($"=== CLAIMS DEBUG ===");
Console.WriteLine($"NameIdentifier: {userIdClaim}");
Console.WriteLine($"Name: {userNameClaim}");
Console.WriteLine($"Role: {userRoleClaim}");
Console.WriteLine($"===================");

if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out int userId))
{
Console.WriteLine($"Looking for user with ID: {userId}");

// Lấy fresh data từ database
using (var scope = DbContext.Database.BeginTransaction())
{
var currentUser = DbContext.TaiKhoan
.Where(u => u.IdTaiKhoan == userId)
.Select(u => new {
u.IdTaiKhoan,
u.TenDangNhap,
u.HoTen,
u.AnhDaiDien,
u.VaiTro,
u.Email
})
.FirstOrDefault();

scope.Rollback(); // Không thay đổi gì, chỉ đọc data

Console.WriteLine($"=== DATABASE RESULT ===");
if (currentUser != null)
{
Console.WriteLine($"Found user: ID={currentUser.IdTaiKhoan}, Username={currentUser.TenDangNhap}, FullName={currentUser.HoTen}");
Console.WriteLine($"Avatar path: {currentUser.AnhDaiDien}");
Console.WriteLine($"Role: {currentUser.VaiTro}");
Console.WriteLine($"Email: {currentUser.Email}");

// Ưu tiên HoTen, sau đó TenDangNhap
userName = !string.IsNullOrEmpty(currentUser.HoTen) ?
currentUser.HoTen :
(currentUser.TenDangNhap ?? "User");

// Xử lý avatar path - CHỈ set khi thực sự có avatar trong DB
if (!string.IsNullOrEmpty(currentUser.AnhDaiDien) && !string.IsNullOrWhiteSpace(currentUser.AnhDaiDien))
{
string cleanPath = currentUser.AnhDaiDien.Trim();
if (cleanPath.StartsWith("/"))
{
avatar = cleanPath;
hasAvatar = true;
}
else if (cleanPath.StartsWith("images/"))
{
avatar = "/" + cleanPath;
hasAvatar = true;
}
else
{
avatar = "/images/" + cleanPath;
hasAvatar = true;
}

Console.WriteLine($"Final avatar path: {avatar}");
}
else
{
avatar = null;
hasAvatar = false; // Rõ ràng không có avatar
Console.WriteLine("No avatar found in database");
}
}
else
{
Console.WriteLine($"ERROR: User with ID {userId} not found in database!");
userName = $"User#{userId}";
avatar = null;
hasAvatar = false;
}
Console.WriteLine($"======================");
}
}
else
{
Console.WriteLine("ERROR: Invalid or missing NameIdentifier claim");
userName = userNameClaim ?? "Unknown";
}
}
catch (Exception ex)
{
Console.WriteLine($"ERROR in top bar: {ex.Message}");
Console.WriteLine($"Stack trace: {ex.StackTrace}");
userName = "Error";
avatar = null;
hasAvatar = false;
}
}
else
{
Console.WriteLine("User not authenticated");
userName = "Guest";
hasAvatar = false;
}

// Final validation
if (string.IsNullOrEmpty(avatar) || string.IsNullOrWhiteSpace(avatar))
{
avatar = null;
hasAvatar = false;
}

if (string.IsNullOrEmpty(userName) || string.IsNullOrWhiteSpace(userName))
{
userName = "User";
}

Console.WriteLine($"=== FINAL VALUES ===");
Console.WriteLine($"UserName: '{userName}'");
Console.WriteLine($"Avatar: '{avatar}'");
Console.WriteLine($"HasAvatar: {hasAvatar}");
Console.WriteLine($"=== TOP BAR DEBUG END ===");
}
<header class="top-bar">

  <div class="user-menu">
    <div class="notifications">
      <i class="fas fa-bell"></i>
      <span class="notification-badge">5</span>
    </div>
    <div class="user-profile" onclick="toggleUserMenu()">
      @if (hasAvatar && !string.IsNullOrEmpty(avatar))
      {
      <img src="@avatar?v=@DateTime.Now.Ticks&r=@Random.Shared.Next()" alt="Avatar @userName" class="avatar" id="topBarAvatar" onerror="handleAvatarError(this)" style="border-radius: 50%; object-fit: cover;" data-has-avatar="true">
      }
      else
      {
      <!-- Không hiện avatar nào cả khi không có trong DB -->
      <div class="no-avatar" id="noAvatarPlaceholder" style="display: none;" data-has-avatar="false"></div>
      }
      <span class="user-name" id="topBarUserName">@userName</span>
      <i class="fas fa-chevron-down"></i>
      <div class="user-dropdown">
        <a href="/profile/profile">
          <i class="fas fa-user"></i>
          Thông tin cá nhân
        </a>
        <a href="#settings">
          <i class="fas fa-cog"></i>
          Cài đặt
        </a>
        <div class="dropdown-divider"></div>
        <a href="/profile/LogOut">
          <i class="fas fa-sign-out-alt"></i>
          Đăng xuất
        </a>
      </div>
    </div>
  </div>
</header>

<script>
  // Function xử lý lỗi avatar - CHỈ khi thực sự có avatar trong DB
  function handleAvatarError(img) {
    console.log('Avatar error occurred');

    // Kiểm tra xem có avatar trong DB hay không
    var hasAvatarInDb = img.getAttribute('data-has-avatar') === 'true';

    if (hasAvatarInDb) {
      console.log('Avatar exists in DB but failed to load, falling back to default');
      img.src = '/images/avatar.jpg?v=' + new Date().getTime();
      img.onerror = null; // Prevent infinite loop
    } else {
      console.log('No avatar in DB, hiding avatar completely');
      img.style.display = 'none';
    }
  }

  // Force refresh user info and avatar
  function refreshUserInfo() {
    console.log('Refreshing user info...');

    // Force reload page to get fresh user data from server
    if (performance.navigation.type !== 1) { // Only if not already refreshed
      setTimeout(function() {
        window.location.reload(true);
      }, 500);
    }
  }

  // Load trang và kiểm tra avatar
  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== TOP BAR JAVASCRIPT START ===');

    var topBarAvatar = document.getElementById('topBarAvatar');
    var topBarUserName = document.getElementById('topBarUserName');
    var noAvatarPlaceholder = document.getElementById('noAvatarPlaceholder');

    // Debug current values from server
    console.log('Server rendered - User name:', topBarUserName?.textContent);
    console.log('Server rendered - Avatar element exists:', !!topBarAvatar);
    console.log('Server rendered - No avatar placeholder exists:', !!noAvatarPlaceholder);

    // Chỉ xử lý avatar nếu thực sự có element avatar (tức là có trong DB)
    if (topBarAvatar) {
      console.log('Avatar element found, checking if has avatar in DB');
      var hasAvatarInDb = topBarAvatar.getAttribute('data-has-avatar') === 'true';
      console.log('Has avatar in DB:', hasAvatarInDb);

      if (hasAvatarInDb) {
        // LUÔN LUÔN ƯU TIÊN THÔNG TIN TỪ SERVER
        // Chỉ áp dụng localStorage cho avatar nếu nó được set từ profile upload
        var updatedAvatarFromProfile = localStorage.getItem('profileAvatarUpdated');
        var updatedUrl = localStorage.getItem('updatedAvatarUrl');

        if (updatedAvatarFromProfile === 'true' && updatedUrl) {
          console.log('Applying avatar from recent profile update:', updatedUrl);
          topBarAvatar.src = updatedUrl + '?t=' + new Date().getTime();

          // Clear flag sau khi áp dụng
          localStorage.removeItem('profileAvatarUpdated');
        }

        // Kiểm tra avatar có load được không
        if (topBarAvatar.src) {
          var img = new Image();
          img.onload = function() {
            console.log('Avatar loaded successfully');
          };
          img.onerror = function() {
            console.log('Avatar failed to load, using default');
            handleAvatarError(topBarAvatar);
          };
          img.src = topBarAvatar.src;
        }
      }
    } else {
      console.log('No avatar element found - user has no avatar in database');
    }

    console.log('=== TOP BAR JAVASCRIPT END ===');
  });

  // Lắng nghe sự kiện cập nhật avatar từ profile
  window.addEventListener('avatarUpdated', function(event) {
    console.log('Avatar update event received:', event.detail);

    if (event.detail.newAvatarUrl) {
      // Nếu có avatar mới, cần tạo element avatar
      var topBarAvatar = document.getElementById('topBarAvatar');
      var userProfile = document.querySelector('.user-profile');
      var userName = document.querySelector('.user-name');

      if (!topBarAvatar && userProfile && userName) {
        // Tạo avatar element mới
        topBarAvatar = document.createElement('img');
        topBarAvatar.id = 'topBarAvatar';
        topBarAvatar.className = 'avatar';
        topBarAvatar.style.borderRadius = '50%';
        topBarAvatar.style.objectFit = 'cover';
        topBarAvatar.setAttribute('data-has-avatar', 'true');
        topBarAvatar.onerror = function() {
          handleAvatarError(this);
        };

        // Insert before username
        userProfile.insertBefore(topBarAvatar, userName);

        // Hide no-avatar placeholder if exists
        var noAvatarPlaceholder = document.getElementById('noAvatarPlaceholder');
        if (noAvatarPlaceholder) {
          noAvatarPlaceholder.style.display = 'none';
        }
      }

      if (topBarAvatar) {
        var timestamp = new Date().getTime();
        topBarAvatar.src = event.detail.newAvatarUrl + '?t=' + timestamp;
        topBarAvatar.setAttribute('data-has-avatar', 'true');
        console.log('Top bar avatar updated via event:', event.detail.newAvatarUrl);

        // Set flag để indicate avatar đã được update từ profile
        localStorage.setItem('profileAvatarUpdated', 'true');

        // Refresh page để cập nhật thông tin user từ server
        setTimeout(refreshUserInfo, 1000);
      }
    }
  });

  // Lắng nghe storage events để sync giữa các tab
  window.addEventListener('storage', function(event) {
    if (event.key === 'updatedAvatarUrl' && event.newValue) {
      var topBarAvatar = document.getElementById('topBarAvatar');
      if (topBarAvatar && topBarAvatar.getAttribute('data-has-avatar') === 'true') {
        topBarAvatar.src = event.newValue + '?t=' + new Date().getTime();
        console.log('Avatar updated from storage:', event.newValue);

        // Set flag để indicate avatar đã được update từ profile
        localStorage.setItem('profileAvatarUpdated', 'true');
      }
    }
  });

  // Lắng nghe sự kiện user info thay đổi
  window.addEventListener('userInfoUpdated', function(event) {
    console.log('User info update event received');
    refreshUserInfo();
  });
</script>